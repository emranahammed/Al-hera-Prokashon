<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arabic Typing with Voice & Harakat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        body {
            font-family: 'Amiri', serif;
            background-color: #f0f4f8;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            line-height: 2.5rem;
        }
        .key-btn {
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }
        .key-btn:active {
            background-color: #e2e8f0;
            transform: translateY(2px);
        }
        .recording {
            animation: pulse 1.5s infinite;
            background-color: #ef4444 !important;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-emerald-600 p-4 text-white text-center">
            <h1 class="text-2xl font-bold mb-1">ржЖрж░ржмрж┐ ржЯрж╛ржЗржкрж┐ржВ ржЯрзБрж▓</h1>
            <p class="text-emerald-100 text-sm">ржнрзЯрзЗрж╕ ржПржмржВ рж╣рж░ржХржд рж╕рж╣ ржЯрж╛ржЗржк ржХрж░рзБржи</p>
        </div>

        <div class="p-6">
            <!-- Text Display Area -->
            <div class="relative mb-6">
                <textarea 
                    id="arabicInput" 
                    class="w-full h-32 p-4 border-2 border-emerald-100 rounded-xl focus:border-emerald-500 focus:ring-0 text-right arabic-text resize-none"
                    placeholder="ржПржЦрж╛ржирзЗ рж▓рж┐ржЦрждрзЗ рж╢рзБрж░рзБ ржХрж░рзБржи..."
                    spellcheck="true"
                ></textarea>
                
                <div class="flex flex-wrap gap-2 mt-4 justify-start" dir="ltr">
                    <button id="voiceBtn" onclick="toggleVoiceTyping()" class="flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                        ЁЯОЩя╕П ржнрзЯрзЗрж╕ ржЯрж╛ржЗржкрж┐ржВ
                    </button>
                    <button onclick="speakText()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                        ЁЯФК рж╢рзБржирзБржи
                    </button>
                    <button onclick="copyToClipboard()" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                        ЁЯУЛ ржХржкрж┐
                    </button>
                    <button onclick="backspace()" class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                        тМл ржорзБржЫрзБржи
                    </button>
                    <button id="clearBtn" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition text-sm">
                        ЁЯЧСя╕П рж╕ржм ржорзБржЫрзБржи
                    </button>
                </div>
            </div>

            <!-- Virtual Keyboard Section -->
            <div class="space-y-4">
                <!-- Harakat (Vowels) -->
                <div class="flex flex-wrap gap-2 justify-center bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <button onclick="insertChar('┘О')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘О</button>
                    <button onclick="insertChar('┘П')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘П</button>
                    <button onclick="insertChar('┘Р')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘Р</button>
                    <button onclick="insertChar('┘Л')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘Л</button>
                    <button onclick="insertChar('┘М')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘М</button>
                    <button onclick="insertChar('┘Н')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘Н</button>
                    <button onclick="insertChar('┘С')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘С</button>
                    <button onclick="insertChar('┘Т')" class="key-btn bg-white border border-emerald-200 w-10 h-10 flex items-center justify-center rounded shadow-sm hover:bg-emerald-100 font-bold text-xl">тЧМ┘Т</button>
                </div>

                <!-- Arabic Letters Keyboard -->
                <div id="keyboard" class="grid grid-cols-6 sm:grid-cols-10 gap-2">
                    <!-- Letters will be generated by JS -->
                </div>
                
                <button onclick="insertChar(' ')" class="w-full key-btn bg-gray-200 border border-gray-300 p-3 rounded-xl shadow-sm hover:bg-gray-300 font-bold text-gray-700 tracking-widest text-sm">
                    SPACE (ржЦрж╛рж▓рж┐ ржЬрж╛рзЯржЧрж╛)
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full opacity-0 transition-opacity pointer-events-none z-50 text-sm">
        Copied!
    </div>

    <script>
        const textarea = document.getElementById('arabicInput');
        const keyboard = document.getElementById('keyboard');
        const clearBtn = document.getElementById('clearBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        
        const letters = "╪╢╪╡╪л┘В┘Б╪║╪╣┘З╪о╪н╪м╪п╪░╪▒╪▓╪│╪┤╪╖╪╕┘Д╪и┘К┘Е┘Ж╪к╪з╪ж╪д╪б╪в╪г╪е╪й┘Й";

        // Speech Recognition Setup
        let recognition;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            // Using Saudi Arabia locale for best accuracy
            recognition.lang = 'ar-SA';
            recognition.continuous = true;
            recognition.interimResults = false; // Set to false to wait for full phrases for better shuddhota

            recognition.onresult = (event) => {
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (finalTranscript) {
                    // Speech-to-text doesn't usually add Tashkeel (harakat) automatically, 
                    // but it ensures high accuracy of the base letters.
                    insertChar(finalTranscript + ' ');
                }
            };

            recognition.onerror = (event) => {
                console.error(event.error);
                stopRecording();
                if (event.error === 'not-allowed') {
                    showToast('ржорж╛ржЗржХрзНрж░рзЛржлрзЛржи ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЕржирзБржорждрж┐ ржирзЗржЗ');
                } else {
                    showToast('ржнрзЯрзЗрж╕ ржЯрж╛ржЗржкрж┐ржВ ржП рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ');
                }
            };

            recognition.onend = () => {
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log("Restarting recognition...");
                    }
                }
            };
        }

        function toggleVoiceTyping() {
            if (!recognition) {
                showToast('ржЖржкржирж╛рж░ ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржнрзЯрзЗрж╕ ржЯрж╛ржЗржкрж┐ржВ рж╕рж╛ржкрзЛрж░рзНржЯ ржХрж░рзЗ ржирж╛');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            isRecording = true;
            try {
                recognition.start();
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = 'ЁЯЫС рж░рзЗржХрж░рзНржб рж╣ржЪрзНржЫрзЗ...';
                showToast('рж╕рзНржкрж╖рзНржЯ ржХрж░рзЗ ржЖрж░ржмрж┐рждрзЗ ржХржерж╛ ржмрж▓рзБржи');
            } catch (e) {
                console.error("Start failed:", e);
            }
        }

        function stopRecording() {
            isRecording = false;
            recognition.stop();
            voiceBtn.classList.remove('recording');
            voiceBtn.innerHTML = 'ЁЯОЩя╕П ржнрзЯрзЗрж╕ ржЯрж╛ржЗржкрж┐ржВ';
        }

        function createKeyboard() {
            keyboard.innerHTML = '';
            [...letters].forEach(char => {
                const btn = document.createElement('button');
                btn.innerText = char;
                btn.className = "key-btn bg-white border border-gray-200 p-3 text-xl rounded-lg shadow-sm hover:bg-gray-50 font-bold text-gray-800 flex items-center justify-center";
                btn.onclick = () => insertChar(char);
                keyboard.appendChild(btn);
            });
        }

        function insertChar(char) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + char + text.substring(end);
            textarea.focus();
            const newPos = start + char.length;
            textarea.setSelectionRange(newPos, newPos);
        }

        function backspace() {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            if (start === end && start > 0) {
                textarea.value = text.substring(0, start - 1) + text.substring(end);
                textarea.setSelectionRange(start - 1, start - 1);
            } else if (start !== end) {
                textarea.value = text.substring(0, start) + text.substring(end);
                textarea.setSelectionRange(start, start);
            }
            textarea.focus();
        }

        clearBtn.addEventListener('click', function() {
            if (textarea.value.length === 0) return;
            const isConfirmed = window.confirm("ржЖржкржирж┐ ржХрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржпрзЗ рж╕ржм рж▓рзЗржЦрж╛ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?");
            if (isConfirmed) {
                textarea.value = '';
                textarea.focus();
                showToast('рж╕ржм ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯрзЗржЫрзЗ');
            }
        });

        function copyToClipboard() {
            if (!textarea.value) {
                showToast('ржХржкрж┐ ржХрж░рж╛рж░ ржХрж┐ржЫрзБ ржирзЗржЗ!');
                return;
            }
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('рж╕ржлрж▓ржнрж╛ржмрзЗ ржХржкрж┐ рж╣рзЯрзЗржЫрзЗ!');
            } catch (err) {
                showToast('ржХржкрж┐ ржХрж░рж╛ рж╕ржорзНржнржм рж╣рзЯржирж┐');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        }

        function speakText() {
            const text = textarea.value;
            if (!text) {
                showToast('ржЖржЧрзЗ ржХрж┐ржЫрзБ рж▓рж┐ржЦрзБржи!');
                return;
            }

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.rate = 0.8;
            
            let voices = window.speechSynthesis.getVoices();
            let arabicVoice = voices.find(v => v.lang.startsWith('ar'));
            if (arabicVoice) utterance.voice = arabicVoice;

            window.speechSynthesis.speak(utterance);
        }

        window.onload = () => {
            createKeyboard();
            // Pre-warm voices
            if (window.speechSynthesis) {
                window.speechSynthesis.getVoices();
            }
        };

        if (speechSynthesis && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }
    </script>
</body>
</html>