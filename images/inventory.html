<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶ì ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶∏ - ‡¶™‡ßç‡¶∞‡ßã ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtiCRqpSeDD9T1LTPJN8zX7E-lFEO69cs",
            authDomain: "enventory-bd354.firebaseapp.com",
            projectId: "enventory-bd354",
            storageBucket: "enventory-bd354.firebasestorage.app",
            messagingSenderId: "842289799896",
            appId: "1:842289799896:web:3bdcd348a296543a1eadad",
            measurementId: "G-4PV0VQ7K81"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smart-shop-pro';

        window.db = db;
        window.appId = appId;
        
        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.userId = user.uid;
                loadDataFromCloud();
            }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar-active {
            background-color: #3b82f6;
            color: white;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r hidden md:flex flex-col no-print">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                <i data-lucide="shield-check"></i> ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶∂‡¶™ ‡¶™‡ßç‡¶∞‡ßã
            </h1>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition sidebar-active" id="btn-dashboard">
                <i data-lucide="home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
            </button>
            <button onclick="switchTab('suppliers')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-suppliers">
                <i data-lucide="users"></i> ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞
            </button>
            <button onclick="switchTab('inventory')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-inventory">
                <i data-lucide="box"></i> ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø
            </button>
            <button onclick="switchTab('pos')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-pos">
                <i data-lucide="shopping-cart"></i> ‡¶™‡¶ø‡¶ì‡¶è‡¶∏ (POS)
            </button>
            <button onclick="switchTab('reports')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-reports">
                <i data-lucide="bar-chart-3"></i> ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
            </button>
            <button onclick="switchTab('accounts')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-accounts">
                <i data-lucide="wallet"></i> ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
            </button>
            <button onclick="switchTab('customers')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-customers">
                <i data-lucide="users"></i> ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞
            </button>
        </nav>
        <div class="p-4 border-t">
            <div id="sync-status" class="text-xs text-center py-1 rounded bg-gray-100 text-gray-500 mb-2">Cloud Sync: Initializing...</div>
            <button onclick="exportJSON()" class="w-full text-xs flex items-center justify-center gap-2 bg-gray-100 p-2 rounded hover:bg-gray-200">
                <i data-lucide="download" class="w-3 h-3"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative">
        <div id="content-area" class="p-6">
            <!-- Dynamic Content -->
        </div>
        <div id="toast" class="fixed bottom-5 right-5 bg-black text-white px-6 py-3 rounded-lg opacity-0 transition-opacity pointer-events-none no-print z-50"></div>
    </main>
</div>

<script>
    // --- State Management ---
    let state = {
        products: JSON.parse(localStorage.getItem('ss_products')) || [],
        sales: JSON.parse(localStorage.getItem('ss_sales')) || [],
        suppliers: JSON.parse(localStorage.getItem('ss_suppliers')) || [],
        history: JSON.parse(localStorage.getItem('ss_history')) || [],
        dueAccounts: JSON.parse(localStorage.getItem('ss_dues')) || { customer: 0, supplier: 0 },
        cart: [],
        customers: JSON.parse(localStorage.getItem('ss_customers')) || []
    };

    // --- Firebase Sync Logic ---
    async function loadDataFromCloud() {
        if (!window.db || !window.userId) return;
        try {
            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js");
            const docRef = doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'state', 'main');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                state = { ...state, ...docSnap.data() };
                saveDataLocally();
                updateSyncStatus("Cloud Synced ‚úÖ", "bg-green-100 text-green-600");
                switchTab(currentTab);
            }
        } catch (e) { console.error(e); }
    }

    async function syncToCloud() {
        if (!window.db || !window.userId) return;
        updateSyncStatus("Syncing...", "bg-yellow-50 text-yellow-600");
        try {
            const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js");
            const docRef = doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'state', 'main');
            await setDoc(docRef, { ...state, lastUpdated: new Date().toISOString() });
            updateSyncStatus("Cloud Synced ‚úÖ", "bg-green-100 text-green-600");
        } catch (e) { updateSyncStatus("Sync Failed", "bg-red-50 text-red-500"); }
    }

    function saveDataLocally() {
        localStorage.setItem('ss_products', JSON.stringify(state.products));
        localStorage.setItem('ss_suppliers', JSON.stringify(state.suppliers));
        localStorage.setItem('ss_sales', JSON.stringify(state.sales));
        localStorage.setItem('ss_history', JSON.stringify(state.history));
        localStorage.setItem('ss_dues', JSON.stringify(state.dueAccounts));
        localStorage.setItem('ss_customers', JSON.stringify(state.customers));
    }

    function saveData() {
        saveDataLocally();
        syncToCloud();
    }

    function updateSyncStatus(text, classes) {
        const el = document.getElementById('sync-status');
        if (el) { el.innerText = text; el.className = `text-xs text-center py-1 rounded mb-2 ${classes}`; }
    }

    // --- Tab Switching ---
    let currentTab = 'dashboard';
    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('sidebar-active'));
        document.getElementById(`btn-${tab}`)?.classList.add('sidebar-active');
        const area = document.getElementById('content-area');
        
        if (tab === 'dashboard') renderDashboard(area);
        else if (tab === 'suppliers') renderSuppliers(area);
        else if (tab === 'inventory') renderInventory(area);
        else if (tab === 'pos') renderPOS(area);
        else if (tab === 'reports') renderReports(area);
        else if (tab === 'accounts') renderAccounts(area);
        else if (tab === 'customers') renderCustomers(area);

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // --- Suppliers Logic ---
    function renderSuppliers(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <button onclick="toggleModal('vendor-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="user-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${state.suppliers.map((v, idx) => `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-blue-600"><i data-lucide="building-2"></i></div>
                            <span class="text-[10px] font-bold bg-gray-100 px-2 py-1 rounded">ID: ${v.id}</span>
                        </div>
                        <h4 class="font-bold text-lg">${v.name}</h4>
                        <p class="text-sm text-gray-500 mt-2">üìû ${v.phone}</p>
                        <p class="text-sm text-gray-500">üìç ${v.address || '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡ßá‡¶á'}</p>
                        <div class="mt-4 pt-4 border-t flex justify-between">
                            <span class="text-xs text-blue-600 font-bold">‡¶™‡¶£‡ßç‡¶Ø: ${state.products.filter(p=>p.vendorId === v.id).length}‡¶ü‡¶ø</span>
                            <button onclick="deleteVendor(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('') || '<div class="col-span-full text-center py-20 text-gray-400">‡¶ï‡ßã‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>'}
            </div>

            <!-- Vendor Modal -->
            <div id="vendor-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</h3>
                    <form onsubmit="addVendor(event)" class="space-y-4">
                        <input type="text" id="v-id" placeholder="‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Unique)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="v-name" placeholder="‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="v-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full p-3 border rounded-xl outline-none" required>
                        <textarea id="v-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full p-3 border rounded-xl outline-none"></textarea>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="toggleModal('vendor-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }

    function addVendor(e) {
        e.preventDefault();
        const v = {
            id: document.getElementById('v-id').value,
            name: document.getElementById('v-name').value,
            phone: document.getElementById('v-phone').value,
            address: document.getElementById('v-address').value
        };
        if(state.suppliers.some(s=>s.id === v.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.suppliers.push(v);
        saveData();
        toggleModal('vendor-modal');
        switchTab('suppliers');
    }

    function deleteVendor(idx) {
        if(confirm("‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            state.suppliers.splice(idx, 1);
            saveData();
            switchTab('suppliers');
        }
    }

    // --- Inventory Logic ---
    function renderInventoryTable(products) {
        const tableBody = document.getElementById('inventory-table-body');
        if (!tableBody) return;

        tableBody.innerHTML = products.map(p => {
            const vendor = state.suppliers.find(s => s.id === p.vendorId);
            const originalIndex = state.products.findIndex(originalP => originalP.id === p.id);
            return `
            <tr class="hover:bg-gray-50">
                <td class="p-4">
                    <div class="font-bold text-gray-800">${p.name}</div>
                    <div class="text-[10px] text-gray-400">ID: ${p.id}</div>
                </td>
                <td class="p-4 text-gray-600">${vendor ? vendor.name : 'Unknown'}</td>
                <td class="p-4 text-center font-medium">‡ß≥${p.buyPrice}</td>
                <td class="p-4 text-center font-bold text-blue-600">‡ß≥${p.sellPrice}</td>
                <td class="p-4 text-center">
                    <span class="px-3 py-1 rounded-full font-bold ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                        ${p.stock} ‡¶ü‡¶ø
                    </span>
                </td>
                <td class="p-4 text-right space-x-2">
                    <button onclick="openEditModal(${originalIndex})" class="text-green-500 text-xs font-bold">‡¶á‡¶°‡¶ø‡¶ü</button>
                    <button onclick="adjustStock(${originalIndex})" class="text-blue-500 text-xs">‡¶∏‡ßç‡¶ü‡¶ï+</button>
                    <button onclick="deleteProduct(${originalIndex})" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4 inline"></i></button>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="6" class="p-10 text-center text-gray-300">‡¶ï‡ßã‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>';
    }

    function handleInventorySearch(term) {
        const lowerCaseTerm = term.toLowerCase().trim();
        if (!lowerCaseTerm) {
            renderInventoryTable(state.products);
            return;
        }
        const filteredProducts = state.products.filter(p => {
            const vendor = state.suppliers.find(s => s.id === p.vendorId);
            const vendorName = vendor ? vendor.name.toLowerCase() : '';
            return p.name.toLowerCase().includes(lowerCaseTerm) ||
                   p.id.toLowerCase().includes(lowerCaseTerm) ||
                   vendorName.includes(lowerCaseTerm);
        });
        renderInventoryTable(filteredProducts);
    }

    function renderInventory(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="toggleModal('product-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="package-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="inventory-search" oninput="handleInventorySearch(this.value)" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 border rounded-xl outline-none">
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[800px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4">‡¶Ü‡¶á‡¶°‡¶ø ‡¶ì ‡¶®‡¶æ‡¶Æ</th>
                            <th class="p-4">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</th>
                            <th class="p-4 text-center">‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-4 text-center">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-4 text-center">‡¶∏‡ßç‡¶ü‡¶ï</th>
                            <th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y">
                        <!-- Table content will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Add Product Modal -->
            <div id="product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶á‡¶®‡¶™‡ßÅ‡¶ü</h3>
                    <form onsubmit="addProduct(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="p-id" placeholder="‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶á‡¶°‡¶ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="text" id="p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded-xl outline-none" required>
                        </div>
                        <select id="p-vendor" class="w-full p-3 border rounded-xl outline-none" required>
                            <option value="">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            ${state.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                        <div class="grid grid-cols-3 gap-4">
                            <input type="number" id="p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="number" id="p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="number" id="p-stock" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty)" class="p-3 border rounded-xl outline-none" required>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('product-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Product Modal -->
            <div id="edit-product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶™‡¶£‡ßç‡¶Ø ‡¶á‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="updateProduct(event)" class="space-y-4">
                        <input type="hidden" id="edit-p-index">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-bold text-gray-500">‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶á‡¶°‡¶ø (Read-only)</label>
                                <input type="text" id="edit-p-id" class="p-3 border rounded-xl outline-none w-full bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="text-sm font-bold">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                                <input type="text" id="edit-p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-bold">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</label>
                            <select id="edit-p-vendor" class="w-full p-3 border rounded-xl outline-none" required>
                                <option value="">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                ${state.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="text-sm font-bold">‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</label>
                                <input type="number" step="any" id="edit-p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                            <div>
                                <label class="text-sm font-bold">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</label>
                                <input type="number" step="any" id="edit-p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('edit-product-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        renderInventoryTable(state.products);
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function addProduct(e) {
        e.preventDefault();
        const p = {
            id: document.getElementById('p-id').value,
            name: document.getElementById('p-name').value,
            vendorId: document.getElementById('p-vendor').value,
            buyPrice: parseFloat(document.getElementById('p-buy').value),
            sellPrice: parseFloat(document.getElementById('p-sell').value),
            stock: parseInt(document.getElementById('p-stock').value)
        };
        if(state.products.some(item=>item.id === p.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.products.push(p);
        saveData();
        toggleModal('product-modal');
        switchTab('inventory');
    }

    function deleteProduct(idx) {
        if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            state.products.splice(idx, 1);
            saveData();
            switchTab('inventory');
        }
    }

    function adjustStock(idx) {
        const val = prompt("‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ï‡¶§ ‡¶™‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá?");
        if(val && !isNaN(val)) {
            state.products[idx].stock += parseInt(val);
            state.history.unshift({ date: new Date().toISOString(), type: 'Stock In', product: state.products[idx].name, qty: parseInt(val) });
            saveData();
            switchTab('inventory');
        }
    }

    function openEditModal(index) {
        const product = state.products[index];
        if (!product) return;

        document.getElementById('edit-p-index').value = index;
        document.getElementById('edit-p-id').value = product.id;
        document.getElementById('edit-p-name').value = product.name;
        document.getElementById('edit-p-vendor').value = product.vendorId;
        document.getElementById('edit-p-buy').value = product.buyPrice;
        document.getElementById('edit-p-sell').value = product.sellPrice;

        toggleModal('edit-product-modal');
    }

    function updateProduct(e) {
        e.preventDefault();
        const index = document.getElementById('edit-p-index').value;
        if (index === '' || index === undefined) return;

        const product = state.products[index];
        if (!product) return;

        product.name = document.getElementById('edit-p-name').value;
        product.vendorId = document.getElementById('edit-p-vendor').value;
        product.buyPrice = parseFloat(document.getElementById('edit-p-buy').value);
        product.sellPrice = parseFloat(document.getElementById('edit-p-sell').value);

        saveData();
        toggleModal('edit-product-modal');
        switchTab('inventory');
        showToast("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
    }

    // --- POS Logic ---
    let currentSelectedProductId = null; // To store the product ID being processed

    function openPosQtyModal(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product || product.stock <= 0) {
            showToast("‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶â‡¶ü!");
            return;
        }

        currentSelectedProductId = productId;
        document.getElementById('pos-qty-product-name').innerText = product.name;
        document.getElementById('pos-qty-product-stock').innerText = product.stock;
        
        const qtyInput = document.getElementById('pos-quantity-input');
        qtyInput.value = 1; // Default quantity
        qtyInput.max = product.stock; // Set max quantity
        qtyInput.min = 1; // Ensure minimum is 1

        toggleModal('pos-qty-modal');
    }

    function addSelectedQuantityToCart() {
        const productId = currentSelectedProductId;
        const quantityInput = document.getElementById('pos-quantity-input');
        const quantity = parseInt(quantityInput.value);

        if (isNaN(quantity) || quantity <= 0) {
            showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!");
            return;
        }

        const product = state.products.find(p => p.id === productId);
        if (!product) {
            showToast("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }

        const existing = state.cart.find(c => c.id === productId);
        const currentCartQty = existing ? existing.qty : 0;

        if (quantity + currentCartQty > product.stock) {
            showToast(`‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${product.stock} ‡¶ü‡¶ø, ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá ${currentCartQty} ‡¶ü‡¶ø‡•§`);
            return;
        }
        
        if (existing) {
            existing.qty += quantity;
        } else {
            state.cart.push({...product, qty: quantity});
        }

        toggleModal('pos-qty-modal'); // Close the modal
        updateCartUI(); // Refresh cart display
        showToast(`${quantity}x ${product.name} ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
    }

    function renderPOS(container) {
        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-2xl border mb-4">
                        <input type="text" id="pos-search" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö..." class="w-full p-3 border rounded-xl outline-none">
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="pos-grid"></div>
                </div>
                <div class="bg-white rounded-2xl border p-4 flex flex-col h-[600px]">
                    <h3 class="font-bold border-b pb-2 mb-4">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
                    <div class="flex-1 overflow-y-auto space-y-3" id="cart-list"></div>
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between"><span>‡¶Æ‡ßã‡¶ü:</span> <span id="pos-total" class="font-black text-xl">‡ß≥0</span></div>
                        <button onclick="checkout()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ</button>
                    </div>
                </div>
            </div>

            <!-- POS Quantity Modal -->
            <div id="pos-qty-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-xl font-bold mb-4" id="pos-qty-product-name"></h3>
                    <p class="text-gray-600 mb-4">‡¶∏‡ßç‡¶ü‡¶ï: <span id="pos-qty-product-stock" class="font-bold"></span> ‡¶ü‡¶ø</p>
                    <input type="hidden" id="pos-qty-product-id">
                    <div class="space-y-4">
                        <div>
                            <label for="pos-quantity-input" class="block text-sm font-medium text-gray-700">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                            <input type="number" id="pos-quantity-input" min="1" value="1" class="w-full p-3 border rounded-xl outline-none mt-1" required>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="toggleModal('pos-qty-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="button" onclick="addSelectedQuantityToCart()" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Modal -->
            <div id="checkout-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-2xl p-6">
                    <h3 class="text-2xl font-bold mb-6">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Customer Details -->
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏</h4>
                            <div class="relative">
                                <input type="text" id="checkout-customer-search" oninput="handleCustomerSearch(this.value)" placeholder="‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ/‡¶´‡ßã‡¶®)" class="w-full p-3 border rounded-xl outline-none">
                                <div id="customer-search-results" class="absolute top-full left-0 right-0 bg-white border rounded-b-xl z-10 max-h-40 overflow-y-auto"></div>
                            </div>
                            <input type="hidden" id="checkout-customer-id">
                            <input type="text" id="checkout-customer-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                            <input type="text" id="checkout-customer-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full p-3 border rounded-xl outline-none" required>
                            <textarea id="checkout-customer-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none"></textarea>
                        </div>

                        <!-- Payment Details -->
                        <div class="space-y-4 bg-gray-50 p-6 rounded-2xl">
                            <h4 class="font-bold text-lg">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
                            <div class="flex justify-between items-center text-xl">
                                <span class="text-gray-600">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</span>
                                <span class="font-black">‡ß≥<span id="checkout-total-amount">0</span></span>
                            </div>
                            <div class="space-y-2">
                                <label for="checkout-paid-amount" class="font-medium">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</label>
                                <input type="number" id="checkout-paid-amount" oninput="handleCheckoutPayment()" class="w-full p-4 border rounded-xl outline-none text-2xl font-bold text-center" required>
                            </div>
                            <div class="flex justify-between items-center text-xl text-red-600">
                                <span class="font-medium">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</span>
                                <span class="font-black">‡ß≥<span id="checkout-due-amount">0</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 mt-6 border-t">
                        <button type="button" onclick="toggleModal('checkout-modal')" class="text-gray-500 px-6 py-3 rounded-xl">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                        <button type="button" onclick="confirmOrder()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold text-lg">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>
        `;
        const searchEl = document.getElementById('pos-search');
        searchEl.addEventListener('input', (e) => {
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(e.target.value.toLowerCase()) || p.id.includes(e.target.value));
            renderPOSGrid(filtered);
        });
        renderPOSGrid(state.products);
        updateCartUI();
    }

    function renderPOSGrid(list) {
        const grid = document.getElementById('pos-grid');
        grid.innerHTML = list.map(p => `
            <div onclick="openPosQtyModal('${p.id}')" class="bg-white p-4 rounded-2xl border cursor-pointer hover:border-blue-500 ${p.stock <= 0 ? 'opacity-50 opacity-100 cursor-not-allowed' : ''}">
                <p class="font-bold truncate">${p.name}</p>
                <div class="flex justify-between mt-2">
                    <span class="text-blue-600 font-bold">‡ß≥${p.sellPrice}</span>
                    <span class="text-[10px] text-gray-400">‡¶∏‡ßç‡¶ü‡¶ï: ${p.stock}</span>
                </div>
            </div>
        `).join('');
    }

    function updateCartUI() {
        const cartList = document.getElementById('cart-list');
        if (!cartList) return;
        
        cartList.innerHTML = state.cart.map((c, i) => `
            <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                <div class="text-xs w-full">
                    <p class="font-bold">${c.name}</p>
                    <div class="flex items-center justify-between mt-1">
                        <div class="flex items-center">
                            <button onclick="changeCartItemQuantity(${i}, -1)" class="text-gray-600 bg-gray-200 px-2 py-0.5 rounded-md hover:bg-gray-300">-</button>
                            <span class="mx-2 font-medium">${c.qty}</span>
                            <button onclick="changeCartItemQuantity(${i}, 1)" class="text-gray-600 bg-gray-200 px-2 py-0.5 rounded-md hover:bg-gray-300">+</button>
                        </div>
                        <span class="font-bold">‡ß≥${(c.sellPrice * c.qty).toLocaleString()}</span>
                    </div>
                </div>
                <button onclick="removeCartItem(${i})" class="text-red-400 ml-2">√ó</button>
            </div>
        `).join('');
        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        document.getElementById('pos-total').innerText = `‡ß≥${total.toLocaleString()}`;
    }

    function changeCartItemQuantity(index, delta) {
        const item = state.cart[index];
        if (!item) return;

        const newQty = item.qty + delta;
        
        if (newQty <= 0) {
            removeCartItem(index);
            return;
        }

        const productInStock = state.products.find(p => p.id === item.id);
        if (productInStock && newQty > productInStock.stock) {
            showToast(`‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${productInStock.stock} ‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§`);
            return;
        }

        item.qty = newQty;
        updateCartUI();
    }

    function removeCartItem(index) {
        state.cart.splice(index, 1);
        updateCartUI();
    }

    function checkout() {
        if(state.cart.length === 0) {
            showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
            return;
        }
        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        
        document.getElementById('checkout-total-amount').innerText = total.toLocaleString();
        document.getElementById('checkout-paid-amount').value = total; // Pre-fill paid amount
        document.getElementById('checkout-due-amount').innerText = '0';
        
        document.getElementById('checkout-customer-search').value = '';
        document.getElementById('checkout-customer-id').value = '';
        document.getElementById('checkout-customer-name').value = '';
        document.getElementById('checkout-customer-phone').value = '';
        document.getElementById('checkout-customer-address').value = '';
        document.getElementById('customer-search-results').innerHTML = '';

        toggleModal('checkout-modal');
        handleCheckoutPayment(); // Initial calculation
    }

    function handleCustomerSearch(query) {
        const resultsContainer = document.getElementById('customer-search-results');
        if (!query.trim()) {
            resultsContainer.innerHTML = '';
            return;
        }
        const filteredCustomers = state.customers.filter(c => 
            c.name.toLowerCase().includes(query.toLowerCase()) || 
            c.phone.includes(query)
        ).slice(0, 5);

        resultsContainer.innerHTML = filteredCustomers.map(c => `
            <div class="p-2 cursor-pointer hover:bg-gray-100" onclick="selectCustomer('${c.id}')">
                <p class="font-bold">${c.name}</p>
                <p class="text-xs text-gray-500">${c.phone}</p>
            </div>
        `).join('');
    }

    function selectCustomer(customerId) {
        const customer = state.customers.find(c => c.id === customerId);
        if (customer) {
            document.getElementById('checkout-customer-id').value = customer.id;
            document.getElementById('checkout-customer-name').value = customer.name;
            document.getElementById('checkout-customer-phone').value = customer.phone;
            document.getElementById('checkout-customer-address').value = customer.address || '';
            document.getElementById('customer-search-results').innerHTML = '';
            document.getElementById('checkout-customer-search').value = customer.name;
        }
    }

    function handleCheckoutPayment() {
        const total = parseFloat(document.getElementById('checkout-total-amount').innerText.replace(/,/g, ''));
        const paid = parseFloat(document.getElementById('checkout-paid-amount').value) || 0;
        const due = total - paid;
        document.getElementById('checkout-due-amount').innerText = due > 0 ? due.toLocaleString() : '0';
    }

    function confirmOrder() {
        const customerId = document.getElementById('checkout-customer-id').value;
        let customerName = document.getElementById('checkout-customer-name').value.trim();
        const customerPhone = document.getElementById('checkout-customer-phone').value.trim();
        
        if (!customerName || !customerPhone) {
            showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§");
            return;
        }

        let finalCustomerId = customerId;

        // If no existing customer was selected, create a new one
        if (!finalCustomerId) {
            // Check if a customer with the same phone number already exists
            const existingCustomer = state.customers.find(c => c.phone === customerPhone);
            if(existingCustomer) {
                showToast("‡¶è‡¶á ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ bereits ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶õ‡ßá‡¶®‡•§");
                finalCustomerId = existingCustomer.id;
                selectCustomer(finalCustomerId); // Populate fields with existing customer data
                return; // Stop processing and let the user verify
            }

            finalCustomerId = 'CUST-' + Date.now();
            const newCustomer = {
                id: finalCustomerId,
                name: customerName,
                phone: customerPhone,
                address: document.getElementById('checkout-customer-address').value.trim(),
                email: '',
                shopName: '',
                totalDue: 0 // Initialize due amount for new customer
            };
            state.customers.push(newCustomer);
        }

        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        const paidAmount = parseFloat(document.getElementById('checkout-paid-amount').value) || 0;
        const dueAmount = total - paidAmount;

        const sale = {
            id: 'INV-'+Date.now(),
            date: new Date().toISOString(),
            items: [...state.cart],
            total: total,
            paidAmount: paidAmount,
            dueAmount: dueAmount,
            customerId: finalCustomerId
        };

        // Update product stock
        state.cart.forEach(item => {
            const p = state.products.find(x => x.id === item.id);
            if (p) {
                p.stock -= item.qty;
            }
            state.history.unshift({ date: sale.date, type: 'Sale', product: item.name, qty: item.qty });
        });
        
        // Update customer's total due amount
        const customer = state.customers.find(c => c.id === finalCustomerId);
        if (customer) {
            customer.totalDue = (customer.totalDue || 0) + dueAmount;
        }

        // Update global due accounts (if you still need it)
        if (dueAmount > 0) {
            state.dueAccounts.customer += dueAmount;
        }

        state.sales.push(sale);
        state.cart = [];
        saveData();

        showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        toggleModal('checkout-modal');
        switchTab('pos');
    }

    // --- Reports Logic ---
    function renderReports(container) {
        const today = new Date().toISOString().split('T')[0];
        const thisMonth = today.substring(0, 7);

        const dailySales = state.sales.filter(s => s.date.startsWith(today));
        const dailyTotal = dailySales.reduce((acc, s) => acc + s.total, 0);

        const monthlySales = state.sales.filter(s => s.date.startsWith(thisMonth));
        const monthlyTotal = monthlySales.reduce((acc, s) => acc + s.total, 0);

        container.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-3xl text-white">
                    <p class="opacity-80 font-bold">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (${today})</p>
                    <h3 class="text-4xl font-black mt-2">‡ß≥${dailyTotal.toLocaleString()}</h3>
                    <p class="text-xs mt-2">‡¶Æ‡ßã‡¶ü ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏: ${dailySales.length} ‡¶ü‡¶ø</p>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-3xl text-white">
                    <p class="opacity-80 font-bold">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø (${new Date().toLocaleString('default', { month: 'long' })})</p>
                    <h3 class="text-4xl font-black mt-2">‡ß≥${monthlyTotal.toLocaleString()}</h3>
                    <p class="text-xs mt-2">‡¶Æ‡ßã‡¶ü ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏: ${monthlySales.length} ‡¶ü‡¶ø</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl border shadow-sm p-6">
                <h4 class="font-bold mb-4">‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr><th class="p-3 text-left">‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</th><th class="p-3 text-left">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="p-3 text-right">‡¶ü‡¶æ‡¶ï‡¶æ</th></tr>
                        </thead>
                        <tbody class="divide-y">
                            ${state.sales.slice().reverse().map(s => `
                                <tr>
                                    <td class="p-3 font-mono text-xs">${s.id}</td>
                                    <td class="p-3 text-gray-500">${new Date(s.date).toLocaleString()}</td>
                                    <td class="p-3 text-right font-bold">‡ß≥${s.total}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="3" class="p-10 text-center text-gray-300">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // --- Dashboard Logic ---
    function renderDashboard(container) {
        const totalSales = state.sales.reduce((acc, s) => acc + s.total, 0);
        const stockVal = state.products.reduce((acc, p) => acc + (p.buyPrice * p.stock), 0);
        
        container.innerHTML = `
            <div class="mb-8">
                <h2 class="text-3xl font-black text-gray-800">‡¶ì‡¶≠‡¶æ‡¶∞‡¶≠‡¶ø‡¶â</h2>
                <p class="text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                    <h3 class="text-3xl font-black text-blue-600">‡ß≥${totalSales.toLocaleString()}</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®‡¶≠‡ßá‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</p>
                    <h3 class="text-3xl font-black text-gray-800">‡ß≥${stockVal.toLocaleString()}</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶Æ‡ßã‡¶ü ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</p>
                    <h3 class="text-3xl font-black text-gray-800">${state.suppliers.length} ‡¶ú‡¶®</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl border shadow-sm">
                <h4 class="font-bold text-red-500 mb-4 flex items-center gap-2"><i data-lucide="alert-circle"></i> ‡¶≤‡ßã-‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</h4>
                <div class="space-y-3">
                    ${state.products.filter(p => p.stock < 5).map(p => `
                        <div class="flex justify-between p-3 bg-red-50 rounded-xl">
                            <span class="font-bold">${p.name}</span>
                            <span class="text-red-600 font-bold">${p.stock} ‡¶ü‡¶ø ‡¶¨‡¶æ‡¶ï‡¶ø</span>
                        </div>
                    `).join('') || '<p class="text-gray-400 text-sm">‡¶∏‡¶¨ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá ‡¶Ü‡¶õ‡ßá‡•§</p>'}
                </div>
            </div>
        `;
    }

    // --- Financials ---
    function renderAccounts(container) {
        const totalCustomerDue = state.customers.reduce((sum, customer) => sum + (customer.totalDue || 0), 0);

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl border shadow-lg text-center">
                    <p class="text-red-500 font-bold mb-2">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                    <h1 class="text-5xl font-black mb-6">‡ß≥${totalCustomerDue.toLocaleString()}</h1>
                    <div class="bg-gray-100 p-3 rounded-xl text-sm text-gray-600">
                        ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶ï‡¶∞‡¶§‡ßá, '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                    </div>
                </div>
                <div class="bg-white p-8 rounded-3xl border shadow-lg text-center">
                    <p class="text-blue-600 font-bold mb-2">‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¶‡ßá‡¶®‡¶æ</p>
                    <h1 class="text-5xl font-black mb-6">‡ß≥${state.dueAccounts.supplier.toLocaleString()}</h1>
                    <div class="flex gap-2"><input type="number" id="pay-s" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" class="flex-1 p-3 border rounded-xl outline-none"><button onclick="updateDue('supplier', -1)" class="bg-blue-600 text-white px-6 rounded-xl">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</button></div>
                </div>
            </div>
        `;
    }

    function updateDue(type, mult) {
        // This function is now only for supplier payments from the accounts tab.
        if (type === 'customer') {
            showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
            return;
        }
        const val = parseFloat(document.getElementById('pay-s').value || 0);
        state.dueAccounts[type] += (val * mult);
        saveData();
        switchTab('accounts');
    }

    // --- Customer Logic ---
    function renderCustomers(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <button onclick="toggleModal('add-customer-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="user-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${state.customers.map((c, idx) => `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-blue-600"><i data-lucide="user"></i></div>
                            <span class="text-[10px] font-bold bg-gray-100 px-2 py-1 rounded">ID: ${c.id}</span>
                        </div>
                        <h4 class="font-bold text-lg">${c.name}</h4>
                        <p class="text-sm text-gray-500 mt-2">üìû ${c.phone}</p>
                        <p class="text-sm text-gray-500">üìß ${c.email || '‡¶®‡ßá‡¶á'}</p>
                        <p class="text-sm text-gray-500">üè† ${c.address || '‡¶®‡ßá‡¶á'}</p>
                        <p class="text-sm text-gray-500">üè¢ ${c.shopName || '‡¶®‡ßá‡¶á'}</p>
                        <p class="font-bold text-red-500 mt-2">‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${(c.totalDue || 0).toLocaleString()}</p>
                        <div class="mt-4 pt-4 border-t flex justify-between items-center">
                            <div class="space-x-2">
                                <button onclick="openCustomerPaymentModal(${idx})" class="text-blue-500 text-xs font-bold">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
                                <button onclick="openEditCustomerModal(${idx})" class="text-green-500 text-xs font-bold">‡¶á‡¶°‡¶ø‡¶ü</button>
                                <button onclick="deleteCustomer(${idx})" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4 inline"></i></button>
                            </div>
                            ${c.phone ? `<a href="https://wa.me/${c.phone.replace(/\D/g,'')}" target="_blank" class="text-blue-500 text-xs flex items-center gap-1">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                            </a>` : ''}
                        </div>
                    </div>
                `).join('') || '<div class="col-span-full text-center py-20 text-gray-400">‡¶ï‡ßã‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>'}
            </div>

            <!-- Customer Payment Modal -->
            <div id="customer-payment-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-xl font-bold mb-2">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶¶‡¶æ‡ßü</h3>
                    <p class="mb-4 text-gray-600">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: <span id="payment-customer-name" class="font-bold"></span></p>
                    
                    <div class="mb-4 bg-gray-100 p-3 rounded-lg text-center">
                        <p class="text-sm">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                        <p class="text-2xl font-bold text-red-600">‡ß≥<span id="payment-customer-due">0</span></p>
                    </div>

                    <input type="hidden" id="payment-customer-index">
                    <div class="space-y-2">
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700">‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶π‡ßü‡ßá‡¶õ‡ßá?</label>
                        <input type="number" id="payment-amount" min="1" class="w-full p-3 border rounded-xl outline-none" required>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" onclick="toggleModal('customer-payment-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                        <button type="button" onclick="recordCustomerPayment()" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>

            <!-- Add Customer Modal -->
            <div id="add-customer-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="addCustomer(event)" class="space-y-4">
                        <input type="text" id="cust-id" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Unique)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="cust-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="cust-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (WhatsApp ‡¶ú‡¶®‡ßç‡¶Ø)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="email" id="cust-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="cust-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="cust-shop-name" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('add-customer-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Customer Modal -->
            <div id="edit-customer-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="updateCustomerDetails(event)" class="space-y-4">
                        <input type="hidden" id="edit-cust-index">
                        <div>
                            <label class="text-sm font-bold text-gray-500">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Read-only)</label>
                            <input type="text" id="edit-cust-id" class="p-3 border rounded-xl outline-none w-full bg-gray-100" readonly>
                        </div>
                        <input type="text" id="edit-cust-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="edit-cust-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (WhatsApp ‡¶ú‡¶®‡ßç‡¶Ø)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="email" id="edit-cust-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="edit-cust-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="edit-cust-shop-name" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('edit-customer-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function addCustomer(e) {
        e.preventDefault();
        const c = {
            id: document.getElementById('cust-id').value,
            name: document.getElementById('cust-name').value,
            phone: document.getElementById('cust-phone').value,
            email: document.getElementById('cust-email').value,
            address: document.getElementById('cust-address').value,
            shopName: document.getElementById('cust-shop-name').value
        };
        if(state.customers.some(cust => cust.id === c.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.customers.push(c);
        saveData();
        toggleModal('add-customer-modal');
        switchTab('customers');
        showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function openEditCustomerModal(index) {
        const customer = state.customers[index];
        if (!customer) return;

        document.getElementById('edit-cust-index').value = index;
        document.getElementById('edit-cust-id').value = customer.id;
        document.getElementById('edit-cust-name').value = customer.name;
        document.getElementById('edit-cust-phone').value = customer.phone;
        document.getElementById('edit-cust-email').value = customer.email;
        document.getElementById('edit-cust-address').value = customer.address;
        document.getElementById('edit-cust-shop-name').value = customer.shopName;

        toggleModal('edit-customer-modal');
    }

    function updateCustomerDetails(e) {
        e.preventDefault();
        const index = document.getElementById('edit-cust-index').value;
        if (index === '' || index === undefined) return;

        const customer = state.customers[index];
        if (!customer) return;

        customer.name = document.getElementById('edit-cust-name').value;
        customer.phone = document.getElementById('edit-cust-phone').value;
        customer.email = document.getElementById('edit-cust-email').value;
        customer.address = document.getElementById('edit-cust-address').value;
        customer.shopName = document.getElementById('edit-cust-shop-name').value;

        saveData();
        toggleModal('edit-customer-modal');
        switchTab('customers');
        showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function deleteCustomer(index) {
        if(confirm("‡¶è‡¶á ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            state.customers.splice(index, 1);
            saveData();
            switchTab('customers');
            showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
    }

    function openCustomerPaymentModal(index) {
        const customer = state.customers[index];
        if (!customer) return;

        document.getElementById('payment-customer-index').value = index;
        document.getElementById('payment-customer-name').innerText = customer.name;
        document.getElementById('payment-customer-due').innerText = (customer.totalDue || 0).toLocaleString();
        document.getElementById('payment-amount').value = '';

        toggleModal('customer-payment-modal');
    }

    function recordCustomerPayment() {
        const index = document.getElementById('payment-customer-index').value;
        const amount = parseFloat(document.getElementById('payment-amount').value);

        if (index === '' || isNaN(amount) || amount <= 0) {
            showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
            return;
        }

        const customer = state.customers[index];
        if (!customer) return;

        customer.totalDue -= amount;
        
        state.history.unshift({ 
            date: new Date().toISOString(), 
            type: 'Due Collection', 
            product: `Payment from ${customer.name}`, 
            qty: amount 
        });

        // Also update the global due account for consistency if needed, though it's now calculated
        state.dueAccounts.customer -= amount;
        if (state.dueAccounts.customer < 0) state.dueAccounts.customer = 0;

        saveData();
        toggleModal('customer-payment-modal');
        switchTab('customers');
        showToast(`‡ß≥${amount} ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    }

    // --- Utilities ---
    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100');
        setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
    }
    function exportJSON() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const a = document.createElement('a'); a.href = data; a.download = "shop_backup.json"; a.click();
    }

    window.onload = () => {
        switchTab('dashboard');
        setTimeout(() => { if(typeof lucide !== 'undefined') lucide.createIcons(); }, 500);
    };
</script>

</body>
</html>