<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Hera Publication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBtiCRqpSeDD9T1LTPJN8zX7E-lFEO69cs",
            authDomain: "enventory-bd354.firebaseapp.com",
            projectId: "enventory-bd354",
            storageBucket: "enventory-bd354.firebasestorage.app",
            messagingSenderId: "842289799896",
            appId: "1:842289799896:web:3bdcd348a296543a1eadad",
            measurementId: "G-4PV0VQ7K81"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'al-hera-prokashon';

        window.db = db;
        window.appId = appId;
        window.firestore = { doc, setDoc, getDoc, onSnapshot, runTransaction };
        window.auth = auth;
        window.authFunctions = { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider };
        window.firebaseConfig = firebaseConfig; // For secondary app initialization
        window.firebaseApp = initializeApp; // For secondary app initialization
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.userId = user.uid;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                await syncToCloud(); // Auto-sync local data on startup
                loadDataFromCloud();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }
        .sidebar-active {
            background-color: #3b82f6;
            color: white;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- Login Screen -->
<div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-[100]">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Al Hera Publication</h1>
            <p class="text-gray-500">‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>
        <form onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                <input type="email" id="login-email" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                <input type="password" id="login-password" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" required>
            </div>
            <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                ‡¶≤‡¶ó‡¶á‡¶®
            </button>
        </form>
        <div class="mt-6 text-center text-xs text-gray-400">
            <p>‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            <button onclick="setupDefaultAdmin()" class="mt-2 text-blue-500 underline hover:text-blue-700">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® (Click Here)</button>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
<header class="flex justify-between items-center p-4 bg-white border-b no-print">
    <h1 class="text-xl font-bold text-blue-600">Al Hera Publication</h1>
    <div class="flex items-center gap-3">
        <button onclick="openProfileModal()" class="flex items-center gap-2 bg-white hover:bg-gray-50 border border-gray-200 px-1.5 py-1.5 pr-3 rounded-full transition-all shadow-sm group" title="‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤">
            <div class="bg-gray-100 group-hover:bg-blue-100 text-gray-600 group-hover:text-blue-600 rounded-full p-1.5 transition-colors">
                <i data-lucide="user" class="w-5 h-5"></i>
            </div>
            <span class="text-sm font-semibold text-gray-700 group-hover:text-blue-600 hidden md:block">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</span>
        </button>
        <button id="menu-toggle-button" class="p-2 md:hidden" style="color: black; z-index: 51;">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </span>
            <span class="close-icon hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </span>
        </button>
    </div>
</header>

<div id="backdrop" class="fixed inset-0 bg-black/50 z-10 hidden"></div>
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r flex-col no-print fixed inset-y-0 left-0 z-50 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out md:flex">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                <i data-lucide="shield-check"></i> Al Hera Publication
            </h1>
        </div>
        <nav class="flex-1 px-4 space-y-1">
            <button onclick="switchTab('dashboard')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition sidebar-active" id="btn-dashboard">
                <i data-lucide="home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
            </button>
            <button onclick="switchTab('suppliers')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition hidden" id="btn-suppliers">
                <i data-lucide="users"></i> ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞
            </button>
            <button onclick="switchTab('inventory')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-inventory">
                <i data-lucide="box"></i> ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø
            </button>
            <button onclick="switchTab('pos')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-pos">
                <i data-lucide="shopping-cart"></i> ‡¶™‡¶ø‡¶ì‡¶è‡¶∏ (POS)
            </button>
            <button onclick="switchTab('reports')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition hidden" id="btn-reports">
                <i data-lucide="bar-chart-3"></i> ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
            </button>
            <button onclick="switchTab('order-history')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition hidden" id="btn-order-history">
                <i data-lucide="history"></i> ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø
            </button>
            <button onclick="switchTab('accounts')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition hidden" id="btn-accounts">
                <i data-lucide="wallet"></i> ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
            </button>
            <button onclick="switchTab('customers')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition" id="btn-customers">
                <i data-lucide="users"></i> ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞
            </button>
            <button onclick="switchTab('users')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 transition hidden" id="btn-users">
                <i data-lucide="shield"></i> ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü
            </button>
        </nav>
        <div class="p-4 border-t">
            <div id="sync-status" class="text-xs text-center py-1 rounded bg-gray-100 text-gray-500 mb-2">Cloud Sync: Initializing...</div>
            <button onclick="exportJSON()" class="w-full text-xs flex items-center justify-center gap-2 bg-gray-100 p-2 rounded hover:bg-gray-200 mb-2">
                <i data-lucide="download" class="w-3 h-3"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
            </button>
            <button onclick="document.getElementById('import-file').click()" class="w-full text-xs flex items-center justify-center gap-2 bg-blue-50 text-blue-600 p-2 rounded hover:bg-blue-100 mb-2">
                <i data-lucide="upload" class="w-3 h-3"></i> ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
            </button>
            <input type="file" id="import-file" class="hidden" accept=".json" onchange="importJSON(this)">
            <button onclick="handleLogout()" class="w-full text-xs flex items-center justify-center gap-2 bg-red-50 text-red-600 p-2 rounded hover:bg-red-100">
                <i data-lucide="log-out" class="w-3 h-3"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative">
        <div id="content-area" class="p-6">
            <!-- Dynamic Content -->
        </div>
        <div id="toast" class="fixed bottom-5 right-5 bg-black text-white px-6 py-3 rounded-lg opacity-0 transition-opacity pointer-events-none no-print z-50"></div>
    </main>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto relative">
        <button onclick="toggleModal('profile-modal')" class="absolute top-4 right-4 p-2 bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-500 rounded-full transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <div class="text-center mb-6 mt-2">
            <div class="relative inline-block">
                <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 border-4 border-blue-100">
                    <i data-lucide="user" class="w-10 h-10"></i>
                </div>
                <span id="profile-badge" class="absolute bottom-2 -right-2 px-3 py-1 rounded-full text-[10px] font-bold text-white bg-gray-500 border-2 border-white shadow-sm uppercase">Staff</span>
            </div>
            <h3 class="text-xl font-bold text-gray-800">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <p class="text-sm text-gray-500">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>
        
        <!-- Profile Info -->
        <form onsubmit="updateUserProfile(event)" class="space-y-4 mb-8 border-b pb-8">
            <div>
                <label class="text-sm font-bold text-gray-500">‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡ßü)</label>
                <input type="email" id="profile-email" class="w-full p-3 border rounded-xl outline-none bg-gray-100 text-gray-500" readonly>
            </div>
            <div>
                <label class="text-sm font-bold">‡¶®‡¶æ‡¶Æ</label>
                <input type="text" id="profile-name" class="w-full p-3 border rounded-xl outline-none" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl font-bold">‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>

        <!-- Change Password -->
        <h4 class="font-bold text-lg mb-4 text-gray-700">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h4>
        <form onsubmit="changeUserPassword(event)" class="space-y-4">
            <input type="password" id="old-password" placeholder="‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" class="w-full p-3 border rounded-xl outline-none" required>
            <input type="password" id="new-password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (min 6 chars)" class="w-full p-3 border rounded-xl outline-none" required minlength="6">
            <input type="password" id="confirm-password" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®" class="w-full p-3 border rounded-xl outline-none" required>
            <button type="submit" class="w-full bg-red-50 text-red-600 py-2 rounded-xl font-bold hover:bg-red-100">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>

        <div class="mt-6 pt-4 border-t space-y-3">
            <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                <i data-lucide="log-out" class="w-5 h-5"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
            <button onclick="toggleModal('profile-modal')" class="w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
    </div>
</div>
</div>

<script>
    const menuToggleButton = document.getElementById('menu-toggle-button');
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');

    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        backdrop.classList.toggle('hidden');
        
        const menuIcon = menuToggleButton.querySelector('.menu-icon');
        const closeIcon = menuToggleButton.querySelector('.close-icon');

        menuIcon.classList.toggle('hidden');
        closeIcon.classList.toggle('hidden');
    }

    menuToggleButton.addEventListener('click', toggleSidebar);
    backdrop.addEventListener('click', toggleSidebar);

    sidebar.addEventListener('click', (e) => {
        if (e.target.closest('.nav-btn')) {
            setTimeout(() => {
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }, 150);
        }
    });

    // --- State Management ---
    let state = {
        products: JSON.parse(localStorage.getItem('ss_products')) || [],
        sales: JSON.parse(localStorage.getItem('ss_sales')) || [],
        suppliers: JSON.parse(localStorage.getItem('ss_suppliers')) || [],
        history: JSON.parse(localStorage.getItem('ss_history')) || [],
        dueAccounts: JSON.parse(localStorage.getItem('ss_dues')) || { customer: 0, supplier: 0 },
        cart: [],
        customers: JSON.parse(localStorage.getItem('ss_customers')) || [],
        users: [] // { email, role, name }
    };

    // --- Firebase Sync Logic ---
    function loadDataFromCloud() {
        if (!window.db || !window.userId) return;
        try {
            const { doc, onSnapshot } = window.firestore;
            const docRef = doc(window.db, 'artifacts', window.appId, 'app_data', 'main');
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    state = { ...state, ...docSnap.data() };
                }
                checkUserRole(); // Re-check role (Moved outside if to handle fresh DB)
                saveDataLocally();
                updateSyncStatus("Cloud Synced (Realtime) üü¢", "bg-green-100 text-green-600");
                switchTab(currentTab);
            });
        } catch (e) { console.error(e); }
    }

    async function syncToCloud() {
        if (!window.db || !window.userId) return;
        updateSyncStatus("Syncing...", "bg-yellow-50 text-yellow-600");
        try {
            const { doc, runTransaction } = window.firestore;
            const docRef = doc(window.db, 'artifacts', window.appId, 'app_data', 'main');
            
            // ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶≠‡¶ø‡¶ú‡¶ø‡¶¨‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá Firebase Console-‡¶è ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶ß‡ßÇ‡¶∏‡¶∞ (italic) ‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡ßü
            const parentRef = doc(window.db, 'artifacts', window.appId);
            window.firestore.setDoc(parentRef, { type: 'project_root' }, { merge: true }).catch(() => {});
            
            await runTransaction(window.db, async (transaction) => {
                const sfDoc = await transaction.get(docRef);
                if (!sfDoc.exists()) {
                    transaction.set(docRef, { ...state, lastUpdated: new Date().toISOString() });
                } else {
                    const serverData = sfDoc.data();
                    
                    // Merge arrays by ID/Key to prevent data loss
                    const mergeArrays = (local, server, key = 'id') => {
                        if (!local) return server || [];
                        if (!server) return local || [];
                        const map = new Map(server.map(i => [i[key], i]));
                        local.forEach(i => { if(i[key]) map.set(i[key], i); });
                        return Array.from(map.values());
                    };

                    const newState = {
                        ...serverData,
                        ...state,
                        products: mergeArrays(state.products, serverData.products, 'id'),
                        sales: mergeArrays(state.sales, serverData.sales, 'id'),
                        suppliers: mergeArrays(state.suppliers, serverData.suppliers, 'id'),
                        customers: mergeArrays(state.customers, serverData.customers, 'id'),
                        users: mergeArrays(state.users, serverData.users, 'email'),
                        lastUpdated: new Date().toISOString()
                    };
                    transaction.set(docRef, newState);
                }
            });
            updateSyncStatus("Cloud Synced ‚úÖ", "bg-green-100 text-green-600");
        } catch (e) { 
            console.error("Sync Error:", e);
            if (e.code === 'permission-denied') {
                alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ! Firebase Console ‡¶è Rules ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
            updateSyncStatus("Sync Failed", "bg-red-50 text-red-500"); 
        }
    }

    function saveDataLocally() {
        localStorage.setItem('ss_products', JSON.stringify(state.products));
        localStorage.setItem('ss_suppliers', JSON.stringify(state.suppliers));
        localStorage.setItem('ss_sales', JSON.stringify(state.sales));
        localStorage.setItem('ss_history', JSON.stringify(state.history));
        localStorage.setItem('ss_dues', JSON.stringify(state.dueAccounts));
        localStorage.setItem('ss_customers', JSON.stringify(state.customers));
    }

    function saveData() {
        saveDataLocally();
        syncToCloud();
    }

    function updateSyncStatus(text, classes) {
        const el = document.getElementById('sync-status');
        if (el) { el.innerText = text; el.className = `text-xs text-center py-1 rounded mb-2 ${classes}`; }
    }

    // --- Auth & Role Logic ---
    let currentUserRole = 'staff'; // Default safe role

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');

        window.authFunctions.signInWithEmailAndPassword(window.auth, email, password)
            .then(() => {
                errorEl.classList.add('hidden');
                // Role check happens in onAuthStateChanged -> loadDataFromCloud -> checkUserRole
            })
            .catch((error) => {
                errorEl.innerText = "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!";
                errorEl.classList.remove('hidden');
                console.error(error);
            });
    }

    async function setupDefaultAdmin() {
        const email = "admin@alhera.com";
        const password = "123456";
        try {
            await window.authFunctions.createUserWithEmailAndPassword(window.auth, email, password);
            alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶´‡¶≤!\n\n‡¶á‡¶Æ‡ßá‡¶á‡¶≤: " + email + "\n‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°: " + password + "\n\n‡¶è‡¶ñ‡¶® ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        } catch (error) {
            if (error.code === 'auth/email-already-in-use') {
                alert("‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§\n\n‡¶á‡¶Æ‡ßá‡¶á‡¶≤: " + email + "\n‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°: " + password + "\n\n‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            } else {
                alert("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
            }
        }
    }

    function handleLogout() {
        window.authFunctions.signOut(window.auth).then(() => {
            window.location.reload();
        });
    }

    function checkUserRole() {
        if (!window.auth.currentUser) return;
        const email = window.auth.currentUser.email;
        
        // Force hardcoded admin for recovery
        if (email === 'admin@alhera.com' || email === 'your.email@gmail.com') {
            currentUserRole = 'admin';
            // Ensure this admin is in the state list
            if (!state.users.find(u => u.email === email)) {
                state.users.push({ email: email, role: 'admin', name: 'Super Admin' });
                saveData();
            }
            updateUIForRole();
            return;
        }

        // If no users exist in DB, make the first user Admin (Setup Mode)
        if (!state.users || state.users.length === 0) {
            state.users = [{ email: email, role: 'admin', name: 'Admin' }];
            saveData();
        }

        const userObj = state.users.find(u => u.email === email);
        currentUserRole = userObj ? userObj.role : 'staff'; // Default to staff if not found
        
        updateUIForRole();
    }

    function updateUIForRole() {
        const role = currentUserRole;
        
        // Hide all restricted buttons first
        ['btn-dashboard', 'btn-suppliers', 'btn-reports', 'btn-order-history', 'btn-accounts', 'btn-users'].forEach(id => {
            document.getElementById(id)?.classList.add('hidden');
        });

        // Show based on role
        if (role === 'admin') {
            ['btn-dashboard', 'btn-suppliers', 'btn-reports', 'btn-order-history', 'btn-accounts', 'btn-users'].forEach(id => {
                document.getElementById(id)?.classList.remove('hidden');
            });
        } else if (role === 'manager') {
            ['btn-dashboard', 'btn-suppliers', 'btn-reports', 'btn-order-history', 'btn-accounts'].forEach(id => {
                document.getElementById(id)?.classList.remove('hidden');
            });
        } else {
            // Staff: Only Inventory, POS, Customers are visible by default (not hidden in list above)
        }
        
        // Refresh current tab if access lost
        if (document.getElementById(`btn-${currentTab}`)?.classList.contains('hidden')) {
            switchTab('pos');
        }
    }

    // --- Tab Switching ---
    let currentTab = 'dashboard';
    function switchTab(tab, callback) {
        currentTab = tab;
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('sidebar-active'));
        document.getElementById(`btn-${tab}`)?.classList.add('sidebar-active');
        const area = document.getElementById('content-area');
        
        if (tab === 'dashboard') renderDashboard(area);
        else if (tab === 'suppliers') renderSuppliers(area);
        else if (tab === 'inventory') renderInventory(area);
        else if (tab === 'pos') renderPOS(area);
        else if (tab === 'reports') renderReports(area);
        else if (tab === 'order-history') renderOrderHistory(area);
        else if (tab === 'accounts') renderAccounts(area);
        else if (tab === 'customers') renderCustomers(area);
        else if (tab === 'users') renderUsers(area);

        

        if (callback && typeof callback === 'function') {
            callback();
        }
    }

    // --- Order History Logic ---
    let orderHistorySearchTerm = ''; // New state variable for search term
    let orderHistoryPage = 1;
    const itemsPerPage = 10;

    function renderOrderHistory(container) {
        let filteredSales = state.sales.slice().reverse();

        if (orderHistorySearchTerm) {
            const searchTermLower = orderHistorySearchTerm.toLowerCase();
            filteredSales = filteredSales.filter(sale => {
                const customer = state.customers.find(c => c.id === sale.customerId) || { name: '' };
                const customerNameLower = customer.name.toLowerCase();
                const invoiceIdLower = sale.id.toLowerCase();

                return invoiceIdLower.includes(searchTermLower) || customerNameLower.includes(searchTermLower);
            });
        }

        // Pagination Logic
        const totalPages = Math.ceil(filteredSales.length / itemsPerPage);
        if (orderHistoryPage > totalPages) orderHistoryPage = totalPages || 1;
        if (orderHistoryPage < 1) orderHistoryPage = 1;

        const start = (orderHistoryPage - 1) * itemsPerPage;
        const paginatedSales = filteredSales.slice(start, start + itemsPerPage);

        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h2>
            </div>
            
            <div class="mb-4">
                <input type="text" id="order-history-search" oninput="handleOrderHistorySearch(this.value)" placeholder="‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ID ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 border rounded-xl outline-none" value="${orderHistorySearchTerm}">
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[900px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ID</th>
                            <th class="p-4">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th class="p-4">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                            <th class="p-4 text-center">‡¶Æ‡ßã‡¶ü</th>
                            <th class="p-4 text-center">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</th>
                            <th class="p-4 text-center">‡¶¨‡¶æ‡¶ï‡¶ø</th>
                            <th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${paginatedSales.map(sale => {
                            const customer = state.customers.find(c => c.id === sale.customerId) || { name: 'N/A' };
                            return `
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-mono text-xs">${sale.id}</td>
                                <td class="p-4">${new Date(sale.date).toLocaleDateString('bn-BD')}</td>
                                <td class="p-4">${customer.name}</td>
                                <td class="p-4 text-center font-bold">‡ß≥${sale.total.toLocaleString()}</td>
                                <td class="p-4 text-center text-green-600">‡ß≥${(sale.paidAmount || 0).toLocaleString()}</td>
                                <td class="p-4 text-center text-red-600">‡ß≥${(sale.dueAmount || 0).toLocaleString()}</td>
                                <td class="p-4 text-right">
                                    <button onclick="openInvoiceModal('${sale.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-xs font-bold">
                                        ‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                                <td class="p-4 text-right flex justify-end gap-2">
                                    <button onclick="openInvoiceModal('${sale.id}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold" title="View">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    ${currentUserRole === 'admin' ? `
                                    <button onclick="openEditOrderModal('${sale.id}')" class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs font-bold" title="Edit Payment">
                                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteOrder('${sale.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs font-bold" title="Delete">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>` : ''}
                                </td>
                            </tr>
                            `;
                        }).join('') || '<tr><td colspan="7" class="p-10 text-center text-gray-300">‡¶ï‡ßã‡¶® ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>'}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="flex justify-between items-center mt-4 bg-white p-4 rounded-xl shadow-sm border">
                <span class="text-sm text-gray-500">‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ${orderHistoryPage} / ${totalPages || 1} (‡¶Æ‡ßã‡¶ü ${filteredSales.length} ‡¶ü‡¶ø)</span>
                <div class="flex gap-2">
                    <button onclick="changeOrderHistoryPage(-1)" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" ${orderHistoryPage === 1 ? 'disabled' : ''}>
                        <i data-lucide="chevron-left" class="w-4 h-4 inline"></i> ‡¶Ü‡¶ó‡ßá‡¶∞
                    </button>
                    <button onclick="changeOrderHistoryPage(1)" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" ${orderHistoryPage >= totalPages ? 'disabled' : ''}>
                        ‡¶™‡¶∞‡ßá‡¶∞ <i data-lucide="chevron-right" class="w-4 h-4 inline"></i>
                    </button>
                </div>
            </div>

            <!-- Invoice Modal -->
            <div id="invoice-modal" class="hidden fixed inset-0 bg-gray-50 flex items-center justify-center z-50 p-4">
                <div id="invoice-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-auto">
                    <!-- Invoice content will be dynamically inserted here -->
                </div>
                <div class="absolute top-4 right-4 no-print">
                    <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-lg hover:bg-blue-700">‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="toggleModal('invoice-modal')" class="bg-red-500 text-white px-6 py-2 rounded-lg shadow-lg hover:bg-red-600 ml-2">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>

            <!-- Edit Order Modal -->
            <div id="edit-order-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h3>
                    <form onsubmit="updateOrder(event)" class="space-y-4">
                        <input type="hidden" id="edit-order-id">
                        <div>
                            <label class="text-sm font-bold">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ (Paid Amount)</label>
                            <input type="number" id="edit-order-paid" class="w-full p-3 border rounded-xl outline-none" required>
                        </div>
                        <div class="flex justify-end gap-2 pt-4">
                            <button type="button" onclick="toggleModal('edit-order-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function changeOrderHistoryPage(delta) {
        orderHistoryPage += delta;
        renderOrderHistory(document.getElementById('content-area'));
    }

    function handleOrderHistorySearch(term) {
        orderHistorySearchTerm = term;
        orderHistoryPage = 1; // Reset to first page on search
        renderOrderHistory(document.getElementById('content-area'));
    }

    function openInvoiceModal(saleId) {
        const sale = state.sales.find(s => s.id === saleId);
        if (!sale) return;

        const customer = state.customers.find(c => c.id === sale.customerId) || {};
        const invoiceContainer = document.getElementById('invoice-content');

        invoiceContainer.innerHTML = `
            <div class="p-8 printable-area">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h1 class="text-3xl font-black text-blue-600">‡¶Ü‡¶≤ ‡¶π‡ßá‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶®</h1>
                        <p class="text-gray-500">‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡ßÄ ‡¶ü‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞, ‡¶¢‡¶æ‡¶ï‡¶æ</p>
                    </div>
                    <div class="text-right">
                        <h2 class="text-xl font-bold">‡¶á‡¶®‡¶≠‡ßü‡ßá‡¶∏</h2>
                        <p class="text-sm text-gray-500 font-mono">${sale.id}</p>
                        <p class="text-sm text-gray-500">${new Date(sale.date).toLocaleDateString('bn-BD')}</p>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg mb-8">
                    <h3 class="font-bold mb-2">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞:</h3>
                    <p class="font-semibold">${customer.name || 'N/A'}</p>
                    <p class="text-sm text-gray-600">${customer.phone || ''}</p>
                    <p class="text-sm text-gray-600">${customer.address || ''}</p>
                </div>

                <table class="w-full text-left mb-8">
                    <thead>
                        <tr class="bg-gray-800 text-white">
                            <th class="p-3">#</th>
                            <th class="p-3">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                            <th class="p-3 text-center">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                            <th class="p-3 text-right">‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-3 text-right">‡¶Æ‡ßã‡¶ü</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.items.map((item, index) => `
                        <tr class="border-b">
                            <td class="p-3">${index + 1}</td>
                            <td class="p-3">${item.name}</td>
                            <td class="p-3 text-center">${item.qty}</td>
                            <td class="p-3 text-right">‡ß≥${item.sellPrice.toLocaleString()}</td>
                            <td class="p-3 text-right font-bold">‡ß≥${(item.qty * item.sellPrice).toLocaleString()}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="flex justify-end">
                    <div class="w-full max-w-xs space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium">‡¶∏‡¶æ‡¶¨-‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</span>
                            <span>‡ß≥${sale.total.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between font-bold text-xl border-t pt-2">
                            <span>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü:</span>
                            <span>‡ß≥${sale.total.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-green-600">
                            <span>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§:</span>
                            <span>‡ß≥${(sale.paidAmount || 0).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between font-bold text-red-600">
                            <span>‡¶¨‡¶æ‡¶ï‡¶ø:</span>
                            <span>‡ß≥${(sale.dueAmount || 0).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                 <div class="text-center mt-12 text-xs text-gray-500">
                    <p>‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§</p>
                </div>
            </div>
        `;
        
        toggleModal('invoice-modal');
    }

    function deleteOrder(saleId) {
        if (currentUserRole !== 'admin') return showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
        if (!confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá:\n‡ßß. ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶´‡ßá‡¶∞‡¶§ ‡¶Ü‡¶∏‡¶¨‡ßá‡•§\n‡ß®. ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶°‡¶ø‡¶â/‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§")) return;

        const saleIndex = state.sales.findIndex(s => s.id === saleId);
        if (saleIndex === -1) return;
        const sale = state.sales[saleIndex];

        // 1. Restore Stock
        sale.items.forEach(item => {
            const product = state.products.find(p => p.id === item.id);
            if (product) product.stock += item.qty;
        });

        // 2. Adjust Customer Due (Reverse the due amount added by this sale)
        if (sale.customerId) {
            const customer = state.customers.find(c => c.id === sale.customerId);
            if (customer) {
                customer.totalDue = (customer.totalDue || 0) - (sale.dueAmount || 0);
                if (customer.totalDue < 0) customer.totalDue = 0; // Safety check
            }
        }

        state.sales.splice(saleIndex, 1);
        saveData();
        renderOrderHistory(document.getElementById('content-area'));
        showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
    }

    function openEditOrderModal(saleId) {
        const sale = state.sales.find(s => s.id === saleId);
        if (!sale) return;
        document.getElementById('edit-order-id').value = sale.id;
        document.getElementById('edit-order-paid').value = sale.paidAmount;
        toggleModal('edit-order-modal');
    }

    function updateOrder(e) {
        e.preventDefault();
        const saleId = document.getElementById('edit-order-id').value;
        const newPaid = parseFloat(document.getElementById('edit-order-paid').value);
        const sale = state.sales.find(s => s.id === saleId);
        
        if (!sale) return;

        // Calculate difference to adjust customer due
        const oldDue = sale.dueAmount;
        const newDue = sale.total - newPaid;

        // Update Sale
        sale.paidAmount = newPaid;
        sale.dueAmount = newDue;

        // Update Customer Due
        if (sale.customerId) {
            const customer = state.customers.find(c => c.id === sale.customerId);
            if (customer) {
                customer.totalDue = (customer.totalDue || 0) - oldDue + newDue;
            }
        }

        saveData();
        toggleModal('edit-order-modal');
        renderOrderHistory(document.getElementById('content-area'));
        showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
    }

    // --- Suppliers Logic ---
    function renderSuppliers(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <button onclick="toggleModal('vendor-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="user-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="mb-6">
                <input type="text" oninput="handleVendorSearch(this.value)" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 border rounded-xl outline-none">
            </div>
            
            <div id="vendor-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

            <!-- Vendor Modal -->
            <div id="vendor-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</h3>
                    <form onsubmit="addVendor(event)" class="space-y-4">
                        <input type="text" id="v-id" placeholder="‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Unique)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="v-name" placeholder="‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="v-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full p-3 border rounded-xl outline-none" required>
                        <textarea id="v-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full p-3 border rounded-xl outline-none"></textarea>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="toggleModal('vendor-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Vendor Modal -->
            <div id="edit-vendor-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h3>
                    <form onsubmit="updateVendor(event)" class="space-y-4">
                        <input type="hidden" id="edit-v-index">
                        <div>
                            <label class="text-sm font-bold text-gray-500">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Read-only)</label>
                            <input type="text" id="edit-v-id" class="w-full p-3 border rounded-xl outline-none bg-gray-100" readonly>
                        </div>
                        <input type="text" id="edit-v-name" placeholder="‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞/‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="edit-v-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full p-3 border rounded-xl outline-none" required>
                        <textarea id="edit-v-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" class="w-full p-3 border rounded-xl outline-none"></textarea>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="toggleModal('edit-vendor-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        renderVendorGrid(state.suppliers.filter(s => !s.isDeleted));
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function handleVendorSearch(term) {
        const lower = term.toLowerCase();
        const filtered = state.suppliers.filter(s => !s.isDeleted && (s.name.toLowerCase().includes(lower) || s.phone.includes(term)));
        renderVendorGrid(filtered);
    }

    function renderVendorGrid(list) {
        const grid = document.getElementById('vendor-grid');
        if(!grid) return;
        
        grid.innerHTML = list.map((v) => {
            const idx = state.suppliers.findIndex(s => s.id === v.id);
            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-blue-600"><i data-lucide="building-2"></i></div>
                        <span class="text-[10px] font-bold bg-gray-100 px-2 py-1 rounded">ID: ${v.id}</span>
                    </div>
                    <h4 class="font-bold text-lg">${v.name}</h4>
                    <p class="text-sm text-gray-500 mt-2">üìû ${v.phone}</p>
                    <p class="text-sm text-gray-500">üìç ${v.address || '‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶®‡ßá‡¶á'}</p>
                    <div class="mt-4 pt-4 border-t flex justify-between items-center">
                        <span class="text-xs text-blue-600 font-bold">‡¶™‡¶£‡ßç‡¶Ø: ${state.products.filter(p=>p.vendorId === v.id).length}‡¶ü‡¶ø</span>
                        <div class="flex gap-2">
                            <button onclick="openEditVendorModal(${idx})" class="text-green-500 hover:text-green-700 flex items-center gap-1 text-xs font-bold" title="Edit"><i data-lucide="edit-2" class="w-3 h-3"></i> ‡¶è‡¶°‡¶ø‡¶ü</button>
                            <button onclick="deleteVendor(${idx})" class="text-red-400 hover:text-red-600 flex items-center gap-1 text-xs font-bold" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('') || '<div class="col-span-full text-center py-20 text-gray-400">‡¶ï‡ßã‡¶® ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>';
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function addVendor(e) {
        e.preventDefault();
        const v = {
            id: document.getElementById('v-id').value,
            name: document.getElementById('v-name').value,
            phone: document.getElementById('v-phone').value,
            address: document.getElementById('v-address').value
        };
        if(state.suppliers.some(s=>s.id === v.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.suppliers.push(v);
        saveData();
        toggleModal('vendor-modal');
        switchTab('suppliers');
    }

    function deleteVendor(idx) {
        if(confirm("‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            // Soft delete to prevent sync restoration issues
            state.suppliers[idx].isDeleted = true;
            saveData();
            switchTab('suppliers');
        }
    }

    function openEditVendorModal(idx) {
        const vendor = state.suppliers[idx];
        if (!vendor) return;
        document.getElementById('edit-v-index').value = idx;
        document.getElementById('edit-v-id').value = vendor.id;
        document.getElementById('edit-v-name').value = vendor.name;
        document.getElementById('edit-v-phone').value = vendor.phone;
        document.getElementById('edit-v-address').value = vendor.address || '';
        toggleModal('edit-vendor-modal');
    }

    function updateVendor(e) {
        e.preventDefault();
        const idx = document.getElementById('edit-v-index').value;
        const vendor = state.suppliers[idx];
        if (!vendor) return;

        vendor.name = document.getElementById('edit-v-name').value;
        vendor.phone = document.getElementById('edit-v-phone').value;
        vendor.address = document.getElementById('edit-v-address').value;

        saveData();
        toggleModal('edit-vendor-modal');
        renderSuppliers(document.getElementById('content-area'));
        showToast("‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    // --- Inventory Logic ---
    function renderInventoryTable(products) {
        const tableBody = document.getElementById('inventory-table-body');
        if (!tableBody) return;

        tableBody.innerHTML = products.map(p => {
            const vendor = state.suppliers.find(s => s.id === p.vendorId);
            const originalIndex = state.products.findIndex(originalP => originalP.id === p.id);
            return `
            <tr class="hover:bg-gray-50">
                <td class="p-4">
                    <div class="font-bold text-gray-800">${p.name}</div>
                    <div class="text-[10px] text-gray-400">ID: ${p.id}</div>
                </td>
                <td class="p-4 text-gray-600">${vendor ? vendor.name : 'Unknown'}</td>
                <td class="p-4 text-center font-medium">‡ß≥${p.buyPrice}</td>
                <td class="p-4 text-center font-bold text-blue-600">‡ß≥${p.sellPrice}</td>
                <td class="p-4 text-center">
                    <span class="px-3 py-1 rounded-full font-bold ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                        ${p.stock} ‡¶ü‡¶ø
                    </span>
                </td>
                <td class="p-4 text-right space-x-2">
                    <button onclick="openEditModal(${originalIndex})" class="text-green-500 text-xs font-bold">‡¶á‡¶°‡¶ø‡¶ü</button>
                    <button onclick="adjustStock(${originalIndex})" class="text-blue-500 text-xs">‡¶∏‡ßç‡¶ü‡¶ï+</button>
                    <button onclick="deleteProduct(${originalIndex})" class="text-red-400 text-xs font-bold" title="Delete"><i data-lucide="trash-2" class="w-3 h-3 inline"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="6" class="p-10 text-center text-gray-300">‡¶ï‡ßã‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>';
    }

    function handleInventorySearch(term) {
        const lowerCaseTerm = term.toLowerCase().trim();
        if (!lowerCaseTerm) {
            renderInventoryTable(state.products.filter(p => !p.isDeleted));
            return;
        }
        const filteredProducts = state.products.filter(p => {
            if (p.isDeleted) return false;
            const vendor = state.suppliers.find(s => s.id === p.vendorId);
            const vendorName = vendor ? vendor.name.toLowerCase() : '';
            return p.name.toLowerCase().includes(lowerCaseTerm) ||
                   p.id.toLowerCase().includes(lowerCaseTerm) ||
                   vendorName.includes(lowerCaseTerm);
        });
        renderInventoryTable(filteredProducts);
    }

    function renderInventory(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="toggleModal('product-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="package-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="inventory-search" oninput="handleInventorySearch(this.value)" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡¶æ ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 border rounded-xl outline-none">
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-sm min-w-[800px]">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4">‡¶Ü‡¶á‡¶°‡¶ø ‡¶ì ‡¶®‡¶æ‡¶Æ</th>
                            <th class="p-4">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</th>
                            <th class="p-4 text-center">‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-4 text-center">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</th>
                            <th class="p-4 text-center">‡¶∏‡ßç‡¶ü‡¶ï</th>
                            <th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="divide-y">
                        <!-- Table content will be rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Add Product Modal -->
            <div id="product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø ‡¶á‡¶®‡¶™‡ßÅ‡¶ü</h3>
                    <form onsubmit="addProduct(event)" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="p-id" placeholder="‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶á‡¶°‡¶ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="text" id="p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded-xl outline-none" required>
                        </div>
                        <select id="p-vendor" class="w-full p-3 border rounded-xl outline-none" required>
                            <option value="">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            ${state.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                        </select>
                        <div class="grid grid-cols-3 gap-4">
                            <input type="number" id="p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="number" id="p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none" required>
                            <input type="number" id="p-stock" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Qty)" class="p-3 border rounded-xl outline-none" required>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('product-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Product Modal -->
            <div id="edit-product-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶™‡¶£‡ßç‡¶Ø ‡¶á‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="updateProduct(event)" class="space-y-4">
                        <input type="hidden" id="edit-p-index">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-bold text-gray-500">‡¶™‡¶£‡ßç‡¶Ø ‡¶Ü‡¶á‡¶°‡¶ø (Read-only)</label>
                                <input type="text" id="edit-p-id" class="p-3 border rounded-xl outline-none w-full bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="text-sm font-bold">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                                <input type="text" id="edit-p-name" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-bold">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</label>
                            <select id="edit-p-vendor" class="w-full p-3 border rounded-xl outline-none" required>
                                <option value="">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                                ${state.suppliers.filter(s => !s.isDeleted).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <label class="text-sm font-bold">‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</label>
                                <input type="number" step="any" id="edit-p-buy" placeholder="‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                            <div>
                                <label class="text-sm font-bold">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø</label>
                                <input type="number" step="any" id="edit-p-sell" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" class="p-3 border rounded-xl outline-none w-full" required>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('edit-product-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        renderInventoryTable(state.products.filter(p => !p.isDeleted));
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function addProduct(e) {
        e.preventDefault();
        const p = {
            id: document.getElementById('p-id').value,
            name: document.getElementById('p-name').value,
            vendorId: document.getElementById('p-vendor').value,
            buyPrice: parseFloat(document.getElementById('p-buy').value),
            sellPrice: parseFloat(document.getElementById('p-sell').value),
            stock: parseInt(document.getElementById('p-stock').value)
        };
        if(state.products.some(item=>item.id === p.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.products.push(p);
        saveData();
        toggleModal('product-modal');
        switchTab('inventory');
    }

    function deleteProduct(idx) {
        if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            // Soft delete to prevent sync restoration issues
            state.products[idx].isDeleted = true;
            saveData();
            switchTab('inventory');
        }
    }

    function adjustStock(idx) {
        const val = prompt("‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ï‡¶§ ‡¶™‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá?");
        if(val && !isNaN(val)) {
            state.products[idx].stock += parseInt(val);
            state.history.unshift({ date: new Date().toISOString(), type: 'Stock In', product: state.products[idx].name, qty: parseInt(val) });
            saveData();
            switchTab('inventory');
        }
    }

    function openEditModal(index) {
        const product = state.products[index];
        if (!product) return;

        document.getElementById('edit-p-index').value = index;
        document.getElementById('edit-p-id').value = product.id;
        document.getElementById('edit-p-name').value = product.name;
        document.getElementById('edit-p-vendor').value = product.vendorId;
        document.getElementById('edit-p-buy').value = product.buyPrice;
        document.getElementById('edit-p-sell').value = product.sellPrice;

        toggleModal('edit-product-modal');
    }

    function updateProduct(e) {
        e.preventDefault();
        const index = document.getElementById('edit-p-index').value;
        if (index === '' || index === undefined) return;

        const product = state.products[index];
        if (!product) return;

        product.name = document.getElementById('edit-p-name').value;
        product.vendorId = document.getElementById('edit-p-vendor').value;
        product.buyPrice = parseFloat(document.getElementById('edit-p-buy').value);
        product.sellPrice = parseFloat(document.getElementById('edit-p-sell').value);

        saveData();
        toggleModal('edit-product-modal');
        switchTab('inventory');
        showToast("‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
    }

    // --- POS Logic ---
    let currentSelectedProductId = null; // To store the product ID being processed

    function openPosQtyModal(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product || product.stock <= 0) {
            showToast("‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶â‡¶ü!");
            return;
        }

        currentSelectedProductId = productId;
        document.getElementById('pos-qty-product-name').innerText = product.name;
        document.getElementById('pos-qty-product-stock').innerText = product.stock;
        
        const qtyInput = document.getElementById('pos-quantity-input');
        qtyInput.value = 1; // Default quantity
        qtyInput.max = product.stock; // Set max quantity
        qtyInput.min = 1; // Ensure minimum is 1

        toggleModal('pos-qty-modal');
    }

    function addSelectedQuantityToCart() {
        const productId = currentSelectedProductId;
        const quantityInput = document.getElementById('pos-quantity-input');
        const quantity = parseInt(quantityInput.value);

        if (isNaN(quantity) || quantity <= 0) {
            showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®!");
            return;
        }

        const product = state.products.find(p => p.id === productId);
        if (!product) {
            showToast("‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
            return;
        }

        const existing = state.cart.find(c => c.id === productId);
        const currentCartQty = existing ? existing.qty : 0;

        if (quantity + currentCartQty > product.stock) {
            showToast(`‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${product.stock} ‡¶ü‡¶ø, ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá ${currentCartQty} ‡¶ü‡¶ø‡•§`);
            return;
        }
        
        if (existing) {
            existing.qty += quantity;
        } else {
            state.cart.push({...product, qty: quantity});
        }

        toggleModal('pos-qty-modal'); // Close the modal
        updateCartUI(); // Refresh cart display
        showToast(`${quantity}x ${product.name} ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
    }

    function renderPOS(container) {
        container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white p-4 rounded-2xl border mb-4">
                        <input type="text" id="pos-search" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö..." class="w-full p-3 border rounded-xl outline-none">
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="pos-grid"></div>
                </div>
                <div class="bg-white rounded-2xl border p-4 flex flex-col h-[600px]">
                    <h3 class="font-bold border-b pb-2 mb-4">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
                    <div class="flex-1 overflow-y-auto space-y-3" id="cart-list"></div>
                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between"><span>‡¶Æ‡ßã‡¶ü:</span> <span id="pos-total" class="font-black text-xl">‡ß≥0</span></div>
                        <button onclick="checkout()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ</button>
                    </div>
                </div>
            </div>

            <!-- POS Quantity Modal -->
            <div id="pos-qty-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-xl font-bold mb-4" id="pos-qty-product-name"></h3>
                    <p class="text-gray-600 mb-4">‡¶∏‡ßç‡¶ü‡¶ï: <span id="pos-qty-product-stock" class="font-bold"></span> ‡¶ü‡¶ø</p>
                    <input type="hidden" id="pos-qty-product-id">
                    <div class="space-y-4">
                        <div>
                            <label for="pos-quantity-input" class="block text-sm font-medium text-gray-700">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                            <input type="number" id="pos-quantity-input" min="1" value="1" class="w-full p-3 border rounded-xl outline-none mt-1" required>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="toggleModal('pos-qty-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="button" onclick="addSelectedQuantityToCart()" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Modal -->
            <div id="checkout-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-2xl p-6">
                    <h3 class="text-2xl font-bold mb-6">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Customer Details -->
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏</h4>
                            <div class="relative">
                                <input type="text" id="checkout-customer-search" oninput="handleCustomerSearch(this.value)" placeholder="‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ/‡¶´‡ßã‡¶®)" class="w-full p-3 border rounded-xl outline-none">
                                <div id="customer-search-results" class="absolute top-full left-0 right-0 bg-white border rounded-b-xl z-10 max-h-40 overflow-y-auto"></div>
                            </div>
                            <input type="hidden" id="checkout-customer-id">
                            <input type="text" id="checkout-customer-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                            <input type="text" id="checkout-customer-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" class="w-full p-3 border rounded-xl outline-none" required>
                            <textarea id="checkout-customer-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none"></textarea>
                        </div>

                        <!-- Payment Details -->
                        <div class="space-y-4 bg-gray-50 p-6 rounded-2xl">
                            <h4 class="font-bold text-lg">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
                            <div class="flex justify-between items-center text-xl">
                                <span class="text-gray-600">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</span>
                                <span class="font-black">‡ß≥<span id="checkout-total-amount">0</span></span>
                            </div>
                            <div class="space-y-2">
                                <label for="checkout-paid-amount" class="font-medium">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</label>
                                <input type="number" id="checkout-paid-amount" oninput="handleCheckoutPayment()" class="w-full p-4 border rounded-xl outline-none text-2xl font-bold text-center" required>
                            </div>
                            <div class="flex justify-between items-center text-xl text-red-600">
                                <span class="font-medium">‡¶¨‡¶æ‡¶ï‡¶ø (Due):</span>
                                <span class="font-black">‡ß≥<span id="checkout-due-amount">0</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 mt-6 border-t">
                        <button type="button" onclick="toggleModal('checkout-modal')" class="text-gray-500 px-6 py-3 rounded-xl">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                        <button type="button" onclick="confirmOrder()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold text-lg">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>
        `;
        const searchEl = document.getElementById('pos-search');
        searchEl.addEventListener('input', (e) => {
            const filtered = state.products.filter(p => !p.isDeleted && (p.name.toLowerCase().includes(e.target.value.toLowerCase()) || p.id.includes(e.target.value)));
            renderPOSGrid(filtered);
        });
        renderPOSGrid(state.products.filter(p => !p.isDeleted));
        updateCartUI();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderPOSGrid(list) {
        const grid = document.getElementById('pos-grid');
        grid.innerHTML = list.map(p => `
            <div onclick="openPosQtyModal('${p.id}')" class="bg-white p-4 rounded-2xl border cursor-pointer hover:border-blue-500 ${p.stock <= 0 ? 'opacity-50 opacity-100 cursor-not-allowed' : ''}">
                <p class="font-bold truncate">${p.name}</p>
                <div class="flex justify-between mt-2">
                    <span class="text-blue-600 font-bold">‡ß≥${p.sellPrice}</span>
                    <span class="text-[10px] text-gray-400">‡¶∏‡ßç‡¶ü‡¶ï: ${p.stock}</span>
                </div>
            </div>
        `).join('');
    }

    function updateCartUI() {
        const cartList = document.getElementById('cart-list');
        if (!cartList) return;
        
        cartList.innerHTML = state.cart.map((c, i) => `
            <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                <div class="text-xs w-full">
                    <p class="font-bold">${c.name}</p>
                    <div class="flex items-center justify-between mt-1">
                        <div class="flex items-center">
                            <button onclick="changeCartItemQuantity(${i}, -1)" class="text-gray-600 bg-gray-200 px-2 py-0.5 rounded-md hover:bg-gray-300">-</button>
                            <span class="mx-2 font-medium">${c.qty}</span>
                            <button onclick="changeCartItemQuantity(${i}, 1)" class="text-gray-600 bg-gray-200 px-2 py-0.5 rounded-md hover:bg-gray-300">+</button>
                        </div>
                        <span class="font-bold">‡ß≥${(c.sellPrice * c.qty).toLocaleString()}</span>
                    </div>
                </div>
                <button onclick="removeCartItem(${i})" class="text-red-400 ml-2">√ó</button>
            </div>
        `).join('');
        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        document.getElementById('pos-total').innerText = `‡ß≥${total.toLocaleString()}`;
    }

    function changeCartItemQuantity(index, delta) {
        const item = state.cart[index];
        if (!item) return;

        const newQty = item.qty + delta;
        
        if (newQty <= 0) {
            removeCartItem(index);
            return;
        }

        const productInStock = state.products.find(p => p.id === item.id);
        if (productInStock && newQty > productInStock.stock) {
            showToast(`‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${productInStock.stock} ‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§`);
            return;
        }

        item.qty = newQty;
        updateCartUI();
    }

    function removeCartItem(index) {
        state.cart.splice(index, 1);
        updateCartUI();
    }

    function checkout() {
        if(state.cart.length === 0) {
            showToast("‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø!");
            return;
        }
        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        
        document.getElementById('checkout-total-amount').innerText = total.toLocaleString();
        document.getElementById('checkout-paid-amount').value = total; // Pre-fill paid amount
        document.getElementById('checkout-due-amount').innerText = '0';
        
        document.getElementById('checkout-customer-search').value = '';
        document.getElementById('checkout-customer-id').value = '';
        document.getElementById('checkout-customer-name').value = '';
        document.getElementById('checkout-customer-phone').value = '';
        document.getElementById('checkout-customer-address').value = '';
        document.getElementById('customer-search-results').innerHTML = '';

        toggleModal('checkout-modal');
        handleCheckoutPayment(); // Initial calculation
    }

    function handleCustomerSearch(query) {
        const resultsContainer = document.getElementById('customer-search-results');
        if (!query.trim()) {
            resultsContainer.innerHTML = '';
            return;
        }
        const filteredCustomers = state.customers.filter(c => 
            c.name.toLowerCase().includes(query.toLowerCase()) || 
            c.phone.includes(query)
        ).slice(0, 5);

        resultsContainer.innerHTML = filteredCustomers.map(c => `
            <div class="p-2 cursor-pointer hover:bg-gray-100" onclick="selectCustomer('${c.id}')">
                <p class="font-bold">${c.name}</p>
                <p class="text-xs text-gray-500">${c.phone}</p>
            </div>
        `).join('');
    }

    function selectCustomer(customerId) {
        const customer = state.customers.find(c => c.id === customerId);
        if (customer) {
            document.getElementById('checkout-customer-id').value = customer.id;
            document.getElementById('checkout-customer-name').value = customer.name;
            document.getElementById('checkout-customer-phone').value = customer.phone;
            document.getElementById('checkout-customer-address').value = customer.address || '';
            document.getElementById('customer-search-results').innerHTML = '';
            document.getElementById('checkout-customer-search').value = customer.name;
        }
    }

    function handleCheckoutPayment() {
        const total = parseFloat(document.getElementById('checkout-total-amount').innerText.replace(/,/g, ''));
        const paid = parseFloat(document.getElementById('checkout-paid-amount').value) || 0;
        const due = total - paid;
        document.getElementById('checkout-due-amount').innerText = due > 0 ? due.toLocaleString() : '0';
    }

    function confirmOrder() {
        const customerId = document.getElementById('checkout-customer-id').value;
        let customerName = document.getElementById('checkout-customer-name').value.trim();
        const customerPhone = document.getElementById('checkout-customer-phone').value.trim();
        
        if (!customerName || !customerPhone) {
            showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§");
            return;
        }

        let finalCustomerId = customerId;

        // If no existing customer was selected, create a new one
        if (!finalCustomerId) {
            // Check if a customer with the same phone number already exists
            const existingCustomer = state.customers.find(c => c.phone === customerPhone);
            if(existingCustomer) {
                showToast("‡¶è‡¶á ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ bereits ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶õ‡ßá‡¶®‡•§");
                finalCustomerId = existingCustomer.id;
                selectCustomer(finalCustomerId); // Populate fields with existing customer data
                return; // Stop processing and let the user verify
            }

            finalCustomerId = 'CUST-' + Date.now();
            const newCustomer = {
                id: finalCustomerId,
                name: customerName,
                phone: customerPhone,
                address: document.getElementById('checkout-customer-address').value.trim(),
                email: '',
                shopName: '',
                totalDue: 0 // Initialize due amount for new customer
            };
            state.customers.push(newCustomer);
        }

        const total = state.cart.reduce((acc, c) => acc + (c.sellPrice * c.qty), 0);
        const paidAmount = parseFloat(document.getElementById('checkout-paid-amount').value) || 0;
        const dueAmount = total - paidAmount;

        const sale = {
            id: 'INV-'+Date.now(),
            date: new Date().toISOString(),
            items: [...state.cart],
            total: total,
            paidAmount: paidAmount,
            dueAmount: dueAmount,
            customerId: finalCustomerId
        };

        // Update product stock
        state.cart.forEach(item => {
            const p = state.products.find(x => x.id === item.id);
            if (p) {
                p.stock -= item.qty;
            }
            state.history.unshift({ date: sale.date, type: 'Sale', product: item.name, qty: item.qty });
        });
        
        // Update customer's total due amount
        const customer = state.customers.find(c => c.id === finalCustomerId);
        if (customer) {
            customer.totalDue = (customer.totalDue || 0) + dueAmount;
        }

        // Update global due accounts (if you still need it)
        if (dueAmount > 0) {
            state.dueAccounts.customer += dueAmount;
        }

        state.sales.push(sale);
        state.cart = [];
        saveData();

        showToast("‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        toggleModal('checkout-modal');
        switchTab('pos');
    }

    // --- Reports Logic ---
    let filteredSales = [];

    async function deleteOldData() {
        if (currentUserRole !== 'admin') {
            showToast("‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§");
            return;
        }

        const months = prompt("‡¶ï‡¶§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: 6)");
        if (!months || isNaN(months)) return;

        const confirmDelete = confirm(`‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Ü‡¶™‡¶®‡¶ø ${months} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ó ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡¶®‡•§ ‡¶è‡¶ü‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`);
        if (!confirmDelete) return;

        updateSyncStatus("Deleting...", "bg-red-50 text-red-600");

        try {
            const { doc, runTransaction } = window.firestore;
            const docRef = doc(window.db, 'artifacts', window.appId, 'app_data', 'main');
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(months));

            let deletedCount = 0;

            await runTransaction(window.db, async (transaction) => {
                const sfDoc = await transaction.get(docRef);
                if (!sfDoc.exists()) throw "Document does not exist!";

                const serverData = sfDoc.data();
                const newSales = (serverData.sales || []).filter(s => new Date(s.date) >= cutoffDate);
                const newHistory = (serverData.history || []).filter(h => new Date(h.date) >= cutoffDate);

                deletedCount = (serverData.sales?.length || 0) + (serverData.history?.length || 0) - (newSales.length + newHistory.length);

                transaction.update(docRef, { sales: newSales, history: newHistory, lastUpdated: new Date().toISOString() });
                state.sales = newSales;
                state.history = newHistory;
            });

            saveDataLocally();
            updateSyncStatus("Cleanup Done ‚úÖ", "bg-green-100 text-green-600");
            showToast(`${deletedCount}‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            if (currentTab === 'reports') renderReports(document.getElementById('content-area'));
        } catch (e) { console.error(e); updateSyncStatus("Delete Failed", "bg-red-50 text-red-500"); showToast("‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"); }
    }

    function renderReports(container, salesData = null) {
        const salesToDisplay = salesData || state.sales.slice().reverse();
        filteredSales = salesToDisplay; // Store for export

        const totalRevenue = salesToDisplay.reduce((acc, s) => acc + s.total, 0);
        const totalPaid = salesToDisplay.reduce((acc, s) => acc + (s.paidAmount || 0), 0);
        const totalDue = salesToDisplay.reduce((acc, s) => acc + (s.dueAmount || 0), 0);
        
        // Get date range for print header
        const startDateValue = document.getElementById('start-date')?.value;
        const endDateValue = document.getElementById('end-date')?.value;
        const dateRangeStr = (startDateValue && endDateValue)
            ? `From ${startDateValue} to ${endDateValue}`
            : 'All Time';

        container.innerHTML = `
            <div class="no-print">
                <h2 class="text-2xl font-bold mb-6">‡¶∏‡ßá‡¶≤‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
            </div>
            
            <div class="bg-white rounded-2xl border shadow-sm p-6 mb-6 no-print">
                <h4 class="font-bold mb-4">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="start-date" class="text-sm font-medium">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="start-date" class="w-full p-2 border rounded-lg mt-1" value="${startDateValue || ''}">
                    </div>
                    <div>
                        <label for="end-date" class="text-sm font-medium">‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="end-date" class="w-full p-2 border rounded-lg mt-1" value="${endDateValue || ''}">
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 md:flex gap-2">
                        <button onclick="filterSalesReport()" class="bg-blue-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-xs md:text-sm flex-1">
                            <i data-lucide="filter" class="w-4 h-4"></i> ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
                        </button>
                        <button onclick="printReport()" class="bg-gray-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-xs md:text-sm flex-1">
                            <i data-lucide="printer" class="w-4 h-4"></i> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
                        </button>
                        <button onclick="exportReportToCSV()" class="bg-green-600 text-white px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-xs md:text-sm flex-1">
                            <i data-lucide="download" class="w-4 h-4"></i> CSV
                        </button>
                        ${currentUserRole === 'admin' ? `<button onclick="deleteOldData()" class="bg-red-100 text-red-600 px-3 py-2 rounded-lg flex items-center justify-center gap-2 text-xs md:text-sm flex-1 hover:bg-red-200">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™
                        </button>` : ''}
                    </div>
                </div>
            </div>

            <div id="report-content">
                <!-- Print Only Header -->
                <div class="hidden print:block mb-8">
                    <h1 class="text-2xl font-bold text-center">Al Hera Publication</h1>
                    <p class="text-center text-sm">Sales Report (${dateRangeStr})</p>
                    <div class="mt-4 pt-4 border-t flex justify-around text-lg">
                        <div><span class="font-bold">Total Sales:</span> ‡ß≥${totalRevenue.toLocaleString()}</div>
                        <div><span class="font-bold">Total Paid:</span> ‡ß≥${totalPaid.toLocaleString()}</div>
                        <div><span class="font-bold">Total Due:</span> ‡ß≥${totalDue.toLocaleString()}</div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-3xl text-white">
                        <p class="opacity-80 font-bold">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                        <h3 class="text-4xl font-black mt-2">‡ß≥${totalRevenue.toLocaleString()}</h3>
                        <p class="text-xs mt-2">‡¶Æ‡ßã‡¶ü ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏: ${salesToDisplay.length} ‡¶ü‡¶ø</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-3xl text-white">
                        <p class="opacity-80 font-bold">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡ßü</p>
                        <h3 class="text-4xl font-black mt-2">‡ß≥${totalPaid.toLocaleString()}</h3>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-3xl text-white">
                        <p class="opacity-80 font-bold">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                        <h3 class="text-4xl font-black mt-2">‡ß≥${totalDue.toLocaleString()}</h3>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border shadow-sm p-6">
                    <h4 class="font-bold mb-4">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3 text-left">‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</th>
                                    <th class="p-3 text-left">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                                    <th class="p-3 text-left">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</th>
                                    <th class="p-3 text-right">‡¶Æ‡ßã‡¶ü</th>
                                    <th class="p-3 text-right">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§</th>
                                    <th class="p-3 text-right">‡¶¨‡¶æ‡¶ï‡¶ø</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${salesToDisplay.map(s => {
                                    const customer = state.customers.find(c => c.id === s.customerId) || { name: 'N/A' };
                                    return `
                                    <tr>
                                        <td class="p-3 font-mono text-xs">${s.id}</td>
                                        <td class="p-3 text-gray-500">${new Date(s.date).toLocaleString('bn-BD')}</td>
                                        <td class="p-3 text-gray-600">${customer.name}</td>
                                        <td class="p-3 text-right font-bold">‡ß≥${s.total.toLocaleString()}</td>
                                        <td class="p-3 text-right text-green-600">‡ß≥${(s.paidAmount || 0).toLocaleString()}</td>
                                        <td class="p-3 text-right text-red-600">‡ß≥${(s.dueAmount || 0).toLocaleString()}</td>
                                    </tr>
                                    `
                                }).join('') || '<tr><td colspan="6" class="p-10 text-center text-gray-300">‡¶ï‡ßã‡¶® ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function filterSalesReport() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶¶‡¶ø‡¶®‡•§");
            return;
        }

        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0); // Set to start of the day

        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999); // Set to end of the day

        const filtered = state.sales.filter(s => {
            const saleDate = new Date(s.date);
            return saleDate >= start && saleDate <= end;
        });

        renderReports(document.getElementById('content-area'), filtered.slice().reverse());
    }

    function printReport() {
        window.print();
    }

    function exportReportToCSV() {
        if (filteredSales.length === 0) {
            showToast("‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        const headers = ["Invoice ID", "Date", "Customer Name", "Total", "Paid", "Due"];
        csvContent += headers.join(",") + "\r\n";

        filteredSales.forEach(sale => {
            const customer = state.customers.find(c => c.id === sale.customerId) || { name: 'N/A' };
            const row = [
                sale.id,
                new Date(sale.date).toLocaleString('bn-BD'),
                `"${customer.name}"`,
                sale.total,
                sale.paidAmount || 0,
                sale.dueAmount || 0
            ];
            csvContent += row.join(",") + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "sales_report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function toggleDashboardFeatures() {
        const allFeatures = document.getElementById('all-dashboard-features');
        const viewAllBtn = document.getElementById('view-all-features-btn');
        if (allFeatures) {
            allFeatures.classList.toggle('hidden');
            if (allFeatures.classList.contains('hidden')) {
                viewAllBtn.innerHTML = '<i data-lucide="more-horizontal"></i><span class="text-xs mt-1">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span>';
            } else {
                viewAllBtn.innerHTML = '<i data-lucide="x"></i><span class="text-xs mt-1">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</span>';
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }

    // --- Dashboard Logic ---
    function renderDashboard(container) {
        const totalSales = state.sales.reduce((acc, s) => acc + s.total, 0);
        const stockVal = state.products.reduce((acc, p) => acc + (p.buyPrice * p.stock), 0);
        
        container.innerHTML = `
            <div class="mb-8">
                <h2 class="text-3xl font-black text-gray-800">‡¶ì‡¶≠‡¶æ‡¶∞‡¶≠‡¶ø‡¶â</h2>
                <p class="text-gray-500">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</p>
            </div>

            <!-- Quick Actions for Mobile -->
            <div class="grid grid-cols-4 gap-4 mb-6 md:hidden">
                <button onclick="switchTab('pos')" class="bg-blue-500 text-white p-3 rounded-xl flex flex-col items-center justify-center text-center">
                    <i data-lucide="shopping-cart"></i>
                    <span class="text-xs mt-1">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶≤</span>
                </button>
                <button onclick="switchTab('inventory', () => toggleModal('product-modal'))" class="bg-green-500 text-white p-3 rounded-xl flex flex-col items-center justify-center text-center">
                    <i data-lucide="package-plus"></i>
                    <span class="text-xs mt-1">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶£‡ßç‡¶Ø</span>
                </button>
                <button onclick="switchTab('reports')" class="bg-purple-500 text-white p-3 rounded-xl flex flex-col items-center justify-center text-center">
                    <i data-lucide="bar-chart-3"></i>
                    <span class="text-xs mt-1">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
                </button>
                 <button id="view-all-features-btn" onclick="toggleDashboardFeatures()" class="bg-gray-700 text-white p-3 rounded-xl flex flex-col items-center justify-center text-center">
                    <i data-lucide="more-horizontal"></i>
                    <span class="text-xs mt-1">‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span>
                </button>
            </div>

            <!-- All Dashboard Features (Hidden by default on mobile) -->
            <div id="all-dashboard-features" class="hidden md:hidden bg-white p-4 rounded-2xl border mb-6">
                <h3 class="font-bold mb-4">‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞</h3>
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="switchTab('dashboard')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="home" class="mb-1"></i><span class="text-xs">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</span></button>
                    <button onclick="switchTab('suppliers')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="users" class="mb-1"></i><span class="text-xs">‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</span></button>
                    <button onclick="switchTab('inventory')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="box" class="mb-1"></i><span class="text-xs">‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø</span></button>
                    <button onclick="switchTab('pos')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="shopping-cart" class="mb-1"></i><span class="text-xs">POS</span></button>
                    <button onclick="switchTab('reports')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="bar-chart-3" class="mb-1"></i><span class="text-xs">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</span></button>
                    <button onclick="switchTab('order-history')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="history" class="mb-1"></i><span class="text-xs">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</span></button>
                    <button onclick="switchTab('accounts')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="wallet" class="mb-1"></i><span class="text-xs">‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</span></button>
                    <button onclick="switchTab('customers')" class="text-gray-700 p-2 rounded-lg flex flex-col items-center text-center"><i data-lucide="users" class="mb-1"></i><span class="text-xs">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞</span></button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                    <h3 class="text-3xl font-black text-blue-600">‡ß≥${totalSales.toLocaleString()}</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®‡¶≠‡ßá‡¶∏‡ßç‡¶ü‡¶Æ‡ßá‡¶®‡ßç‡¶ü</p>
                    <h3 class="text-3xl font-black text-gray-800">‡ß≥${stockVal.toLocaleString()}</h3>
                </div>
                <div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <p class="text-xs font-bold text-gray-400 uppercase">‡¶Æ‡ßã‡¶ü ‡¶≠‡ßá‡¶®‡ßç‡¶°‡¶∞</p>
                    <h3 class="text-3xl font-black text-gray-800">${state.suppliers.filter(s => !s.isDeleted).length} ‡¶ú‡¶®</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl border shadow-sm">
                <h4 class="font-bold text-red-500 mb-4 flex items-center gap-2"><i data-lucide="alert-circle"></i> ‡¶≤‡ßã-‡¶∏‡ßç‡¶ü‡¶ï ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü</h4>
                <div class="space-y-3">
                    ${state.products.filter(p => p.stock < 5).map(p => `
                        <div class="flex justify-between p-3 bg-red-50 rounded-xl">
                            <span class="font-bold">${p.name}</span>
                            <span class="text-red-600 font-bold">${p.stock} ‡¶ü‡¶ø ‡¶¨‡¶æ‡¶ï‡¶ø</span>
                        </div>
                    `).join('') || '<p class="text-gray-400 text-sm">‡¶∏‡¶¨ ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£‡ßá ‡¶Ü‡¶õ‡ßá‡•§</p>'}
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // --- Financials ---
    function renderAccounts(container) {
        const totalCustomerDue = state.customers.reduce((sum, customer) => sum + (customer.totalDue || 0), 0);

        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl border shadow-lg text-center">
                    <p class="text-red-500 font-bold mb-2">‡¶Æ‡ßã‡¶ü ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                    <h1 class="text-5xl font-black mb-6">‡ß≥${totalCustomerDue.toLocaleString()}</h1>
                    <div class="bg-gray-100 p-3 rounded-xl text-sm text-gray-600">
                        ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶ï‡¶∞‡¶§‡ßá, '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                    </div>
                </div>
                <div class="bg-white p-8 rounded-3xl border shadow-lg text-center">
                    <p class="text-blue-600 font-bold mb-2">‡¶∏‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¶‡ßá‡¶®‡¶æ</p>
                    <h1 class="text-5xl font-black mb-6">‡ß≥${state.dueAccounts.supplier.toLocaleString()}</h1>
                    <div class="flex gap-2"><input type="number" id="pay-s" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ" class="flex-1 p-3 border rounded-xl outline-none"><button onclick="updateDue('supplier', -1)" class="bg-blue-600 text-white px-6 rounded-xl">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</button></div>
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function updateDue(type, mult) {
        // This function is now only for supplier payments from the accounts tab.
        if (type === 'customer') {
            showToast("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", "error");
            return;
        }
        const val = parseFloat(document.getElementById('pay-s').value || 0);
        state.dueAccounts[type] += (val * mult);
        saveData();
        switchTab('accounts');
    }

    // --- Customer Logic ---
    function renderCustomers(container) {
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <button onclick="toggleModal('add-customer-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="user-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
            
            <div class="mb-6">
                <input type="text" oninput="handleCustomerListSearch(this.value)" placeholder="‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="w-full p-3 border rounded-xl outline-none">
            </div>
            
            <div id="customer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <!-- Customer Payment Modal -->
            <div id="customer-payment-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6">
                    <h3 class="text-xl font-bold mb-2">‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶¶‡¶æ‡ßü</h3>
                    <p class="mb-4 text-gray-600">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞: <span id="payment-customer-name" class="font-bold"></span></p>
                    
                    <div class="mb-4 bg-gray-100 p-3 rounded-lg text-center">
                        <p class="text-sm">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ‡¶ï‡¶ø</p>
                        <p class="text-2xl font-bold text-red-600">‡ß≥<span id="payment-customer-due">0</span></p>
                    </div>

                    <input type="hidden" id="payment-customer-index">
                    <div class="space-y-2">
                        <label for="payment-amount" class="block text-sm font-medium text-gray-700">‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶π‡ßü‡ßá‡¶õ‡ßá?</label>
                        <input type="number" id="payment-amount" min="1" class="w-full p-3 border rounded-xl outline-none" required>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" onclick="toggleModal('customer-payment-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                        <button type="button" onclick="recordCustomerPayment()" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
            </div>

            <!-- Add Customer Modal -->
            <div id="add-customer-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="addCustomer(event)" class="space-y-4">
                        <input type="text" id="cust-id" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Unique)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="cust-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="cust-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (WhatsApp ‡¶ú‡¶®‡ßç‡¶Ø)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="email" id="cust-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="cust-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="cust-shop-name" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('add-customer-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Customer Modal -->
            <div id="edit-customer-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-lg p-6">
                    <h3 class="text-xl font-bold mb-6">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶á‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <form onsubmit="updateCustomerDetails(event)" class="space-y-4">
                        <input type="hidden" id="edit-cust-index">
                        <div>
                            <label class="text-sm font-bold text-gray-500">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (Read-only)</label>
                            <input type="text" id="edit-cust-id" class="p-3 border rounded-xl outline-none w-full bg-gray-100" readonly>
                        </div>
                        <input type="text" id="edit-cust-name" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="edit-cust-phone" placeholder="‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (WhatsApp ‡¶ú‡¶®‡ßç‡¶Ø)" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="email" id="edit-cust-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="edit-cust-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="edit-cust-shop-name" placeholder="‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" class="w-full p-3 border rounded-xl outline-none">
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="toggleModal('edit-customer-modal')" class="text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        renderCustomerGrid(state.customers.filter(c => !c.isDeleted));
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function handleCustomerListSearch(term) {
        const lower = term.toLowerCase();
        const filtered = state.customers.filter(c => !c.isDeleted && (c.name.toLowerCase().includes(lower) || c.phone.includes(term)));
        renderCustomerGrid(filtered);
    }

    function renderCustomerGrid(list) {
        const grid = document.getElementById('customer-grid');
        if (!grid) return;

        grid.innerHTML = list.map((c) => {
            const idx = state.customers.findIndex(original => original.id === c.id);
            return `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-blue-600"><i data-lucide="user"></i></div>
                        <span class="text-[10px] font-bold bg-gray-100 px-2 py-1 rounded">ID: ${c.id}</span>
                    </div>
                    <h4 class="font-bold text-lg">${c.name}</h4>
                    <p class="text-sm text-gray-500 mt-2">üìû ${c.phone}</p>
                    <p class="text-sm text-gray-500">üìß ${c.email || '‡¶®‡ßá‡¶á'}</p>
                    <p class="text-sm text-gray-500">üè† ${c.address || '‡¶®‡ßá‡¶á'}</p>
                    <p class="text-sm text-gray-500">üè¢ ${c.shopName || '‡¶®‡ßá‡¶á'}</p>
                    <p class="font-bold text-red-500 mt-2">‡¶¨‡¶æ‡¶ï‡¶ø: ‡ß≥${(c.totalDue || 0).toLocaleString()}</p>
                    <div class="mt-4 pt-4 border-t flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="openCustomerPaymentModal(${idx})" class="text-blue-500 text-xs font-bold bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
                            <button onclick="openEditCustomerModal(${idx})" class="text-green-500 text-xs font-bold flex items-center gap-1" title="Edit"><i data-lucide="edit-2" class="w-3 h-3"></i> ‡¶è‡¶°‡¶ø‡¶ü</button>
                            <button onclick="deleteCustomer(${idx})" class="text-red-400 text-xs font-bold flex items-center gap-1 hover:text-red-600" title="Delete"><i data-lucide="trash-2" class="w-3 h-3"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                        </div>
                        ${c.phone ? `<a href="https://wa.me/${c.phone.replace(/\D/g,'')}" target="_blank" class="text-blue-500 text-xs flex items-center gap-1">
                            <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                        </a>` : ''}
                    </div>
                </div>
            `;
        }).join('') || '<div class="col-span-full text-center py-20 text-gray-400">‡¶ï‡ßã‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>';
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function addCustomer(e) {
        e.preventDefault();
        const c = {
            id: document.getElementById('cust-id').value,
            name: document.getElementById('cust-name').value,
            phone: document.getElementById('cust-phone').value,
            email: document.getElementById('cust-email').value,
            address: document.getElementById('cust-address').value,
            shopName: document.getElementById('cust-shop-name').value
        };
        if(state.customers.some(cust => cust.id === c.id)) return showToast("‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        state.customers.push(c);
        saveData();
        toggleModal('add-customer-modal');
        switchTab('customers');
        showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function openEditCustomerModal(index) {
        const customer = state.customers[index];
        if (!customer) return;

        document.getElementById('edit-cust-index').value = index;
        document.getElementById('edit-cust-id').value = customer.id;
        document.getElementById('edit-cust-name').value = customer.name;
        document.getElementById('edit-cust-phone').value = customer.phone;
        document.getElementById('edit-cust-email').value = customer.email;
        document.getElementById('edit-cust-address').value = customer.address;
        document.getElementById('edit-cust-shop-name').value = customer.shopName;

        toggleModal('edit-customer-modal');
    }

    function updateCustomerDetails(e) {
        e.preventDefault();
        const index = document.getElementById('edit-cust-index').value;
        if (index === '' || index === undefined) return;

        const customer = state.customers[index];
        if (!customer) return;

        customer.name = document.getElementById('edit-cust-name').value;
        customer.phone = document.getElementById('edit-cust-phone').value;
        customer.email = document.getElementById('edit-cust-email').value;
        customer.address = document.getElementById('edit-cust-address').value;
        customer.shopName = document.getElementById('edit-cust-shop-name').value;

        saveData();
        toggleModal('edit-customer-modal');
        switchTab('customers');
        showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function deleteCustomer(index) {
        if(confirm("‡¶è‡¶á ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            // Soft delete to prevent sync restoration issues
            state.customers[index].isDeleted = true;
            saveData();
            switchTab('customers');
            showToast("‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
    }

    function openCustomerPaymentModal(index) {
        const customer = state.customers[index];
        if (!customer) return;

        document.getElementById('payment-customer-index').value = index;
        document.getElementById('payment-customer-name').innerText = customer.name;
        document.getElementById('payment-customer-due').innerText = (customer.totalDue || 0).toLocaleString();
        document.getElementById('payment-amount').value = '';

        toggleModal('customer-payment-modal');
    }

    function recordCustomerPayment() {
        const index = document.getElementById('payment-customer-index').value;
        const amount = parseFloat(document.getElementById('payment-amount').value);

        if (index === '' || isNaN(amount) || amount <= 0) {
            showToast("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
            return;
        }

        const customer = state.customers[index];
        if (!customer) return;

        customer.totalDue -= amount;
        
        state.history.unshift({ 
            date: new Date().toISOString(), 
            type: 'Due Collection', 
            product: `Payment from ${customer.name}`, 
            qty: amount 
        });

        // Also update the global due account for consistency if needed, though it's now calculated
        state.dueAccounts.customer -= amount;
        if (state.dueAccounts.customer < 0) state.dueAccounts.customer = 0;

        saveData();
        toggleModal('customer-payment-modal');
        switchTab('customers');
        showToast(`‡ß≥${amount} ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
    }

    // --- User Management (Admin Only) ---
    function renderUsers(container) {
        if (currentUserRole !== 'admin') {
            container.innerHTML = '<div class="text-center p-10 text-red-500">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶á ‡¶™‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§</div>';
            return;
        }

        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                <button onclick="toggleModal('add-user-modal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl flex items-center gap-2">
                    <i data-lucide="user-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4">‡¶®‡¶æ‡¶Æ</th>
                            <th class="p-4">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                            <th class="p-4">‡¶∞‡ßã‡¶≤</th>
                            <th class="p-4 text-right">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${state.users.map((u, idx) => `
                            <tr>
                                <td class="p-4 font-bold">${u.name}</td>
                                <td class="p-4">${u.email}</td>
                                <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${u.role==='admin'?'bg-purple-100 text-purple-600':(u.role==='manager'?'bg-blue-100 text-blue-600':'bg-gray-100 text-gray-600')}">${u.role.toUpperCase()}</span></td>
                                <td class="p-4 text-right">
                                    ${u.email !== window.auth.currentUser.email ? `<button onclick="deleteUser(${idx})" class="text-red-500 text-xs hover:underline">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>` : '<span class="text-gray-400 text-xs">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</span>'}
                                <td class="p-4 text-right space-x-2">
                                    <button onclick="openEditUserModal(${idx})" class="text-green-500 text-xs font-bold">‡¶á‡¶°‡¶ø‡¶ü</button>
                                    ${u.email !== window.auth.currentUser.email ? `<button onclick="deleteUser(${idx})" class="text-red-500 text-xs hover:underline">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>

            <!-- Add User Modal -->
            <div id="add-user-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø</h3>
                    <form onsubmit="createNewUser(event)" class="space-y-4">
                        <input type="text" id="new-user-name" placeholder="‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="email" id="new-user-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="password" id="new-user-pass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (min 6 chars)" class="w-full p-3 border rounded-xl outline-none" required minlength="6">
                        <select id="new-user-role" class="w-full p-3 border rounded-xl outline-none">
                            <option value="staff">Staff</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                        <div class="flex justify-end gap-2 pt-4">
                            <button type="button" onclick="toggleModal('add-user-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div id="edit-user-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl w-full max-w-md p-6">
                    <h3 class="text-xl font-bold mb-4">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü</h3>
                    <form onsubmit="updateUser(event)" class="space-y-4">
                        <input type="hidden" id="edit-user-index">
                        <input type="text" id="edit-user-name" placeholder="‡¶®‡¶æ‡¶Æ" class="w-full p-3 border rounded-xl outline-none" required>
                        <input type="text" id="edit-user-email" class="w-full p-3 border rounded-xl outline-none bg-gray-100" readonly>
                        <select id="edit-user-role" class="w-full p-3 border rounded-xl outline-none">
                            <option value="staff">Staff</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                        <div class="flex justify-end gap-2 pt-4">
                            <button type="button" onclick="toggleModal('edit-user-modal')" class="px-4 py-2 text-gray-500">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-xl">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    async function createNewUser(e) {
        e.preventDefault();
        const name = document.getElementById('new-user-name').value;
        const email = document.getElementById('new-user-email').value;
        const password = document.getElementById('new-user-pass').value;
        const role = document.getElementById('new-user-role').value;

        try {
            // Use a secondary app instance to create user without logging out the admin
            const secondaryApp = window.firebaseApp(window.firebaseConfig, "SecondaryApp");
            const secondaryAuth = window.authFunctions.getAuth(secondaryApp);
            
            await window.authFunctions.createUserWithEmailAndPassword(secondaryAuth, email, password);
            
            // Add to database state
            state.users.push({ name, email, role });
            saveData();
            
            // Cleanup
            window.authFunctions.signOut(secondaryAuth); // Sign out secondary
            // Note: deleteApp is not imported, but leaving the instance is fine for this scope or we can just ignore it.

            toggleModal('add-user-modal');
            renderUsers(document.getElementById('content-area'));
            showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        } catch (error) {
            console.error(error);
            showToast("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
        }
    }

    function openEditUserModal(idx) {
        const user = state.users[idx];
        if (!user) return;
        document.getElementById('edit-user-index').value = idx;
        document.getElementById('edit-user-name').value = user.name;
        document.getElementById('edit-user-email').value = user.email;
        document.getElementById('edit-user-role').value = user.role;
        toggleModal('edit-user-modal');
    }

    function updateUser(e) {
        e.preventDefault();
        const idx = document.getElementById('edit-user-index').value;
        state.users[idx].name = document.getElementById('edit-user-name').value;
        state.users[idx].role = document.getElementById('edit-user-role').value;
        saveData();
        toggleModal('edit-user-modal');
        renderUsers(document.getElementById('content-area'));
        showToast("‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function deleteUser(idx) {
        if(confirm("‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? (Firebase Auth ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá)")) {
            state.users.splice(idx, 1);
            saveData();
            renderUsers(document.getElementById('content-area'));
        }
    }

    // --- Profile & Password Logic ---
    function openProfileModal() {
        const user = window.auth.currentUser;
        if (!user) return;
        
        const localUser = state.users.find(u => u.email === user.email) || {};
        
        document.getElementById('profile-email').value = user.email;
        document.getElementById('profile-name').value = localUser.name || user.displayName || '';

        // Update Badge
        const role = (localUser.role || 'staff').toLowerCase();
        const badge = document.getElementById('profile-badge');
        if (badge) {
            badge.innerText = role.toUpperCase();
            badge.className = `absolute bottom-2 -right-2 px-3 py-1 rounded-full text-[10px] font-bold text-white border-2 border-white shadow-sm uppercase ${
                role === 'admin' ? 'bg-purple-600' : (role === 'manager' ? 'bg-blue-600' : 'bg-gray-500')
            }`;
        }
        
        // Reset password fields
        document.getElementById('old-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        
        toggleModal('profile-modal');
    }

    async function updateUserProfile(e) {
        e.preventDefault();
        const name = document.getElementById('profile-name').value;
        const user = window.auth.currentUser;
        
        try {
            await window.authFunctions.updateProfile(user, { displayName: name });
            
            // Update local state
            const localUserIdx = state.users.findIndex(u => u.email === user.email);
            if (localUserIdx !== -1) {
                state.users[localUserIdx].name = name;
                saveData();
            }
            
            showToast("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        } catch (error) {
            console.error(error);
            showToast("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
        }
    }

    async function changeUserPassword(e) {
        e.preventDefault();
        const oldPass = document.getElementById('old-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmPass = document.getElementById('confirm-password').value;
        
        if (newPass !== confirmPass) return showToast("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!");
        
        const user = window.auth.currentUser;
        const credential = window.authFunctions.EmailAuthProvider.credential(user.email, oldPass);

        try {
            await window.authFunctions.reauthenticateWithCredential(user, credential);
            await window.authFunctions.updatePassword(user, newPass);
            showToast("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            document.getElementById('old-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        } catch (error) {
            console.error(error);
            if (error.code === 'auth/wrong-password') showToast("‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!");
            else showToast("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
        }
    }

    // --- Utilities ---
    function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100');
        setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
    }
    function exportJSON() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const a = document.createElement('a'); a.href = data; a.download = "shop_backup.json"; a.click();
    }

    function importJSON(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                if (confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
                    state = { ...state, ...data };
                    saveData(); // Save to local and cloud
                    alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
                    window.location.reload();
                }
            } catch (error) {
                console.error(error);
                showToast("‡¶≠‡ßÅ‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü! ‡¶∏‡¶†‡¶ø‡¶ï JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
            input.value = ''; // Reset input
        };
        reader.readAsText(file);
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        switchTab('dashboard');
    });
</script>

</body>
</html>
